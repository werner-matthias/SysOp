<!doctype html>
<html class="no-js" lang="de">
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>Reihenfolge</title>
	<link rel="stylesheet" type="text/css" href="https://werner-matthias.github.io/SysOp/assets/css/styles_feeling_responsive.css" />
	<script src="https://werner-matthias.github.io/SysOp/assets/js/modernizr.min.js"></script>

  <script src="https://ajax.googleapis.com/ajax/libs/webfont/1.5.18/webfont.js"></script>
  <script>
    WebFont.load({
      google: {
        families: [ 'Lato:400,700,400italic:latin', 'Volkhov::latin' ]
      }
    });
  </script>

  <noscript>
    <link href='http://fonts.googleapis.com/css?family=Lato:400,700,400italic|Volkhov' rel='stylesheet' type='text/css' />
  </noscript>

  
	
	<meta name="description" content="Moderne Compiler sind gut in der Lage, Code zu optimieren, so dass viele Performance-Tricks auf der Hochsprachenebene hinfällig geworden sind. Aber manchmal muss man den Compiler auch überzeugen, nicht zuviel des Guten zu tun."/>

	

	



	
	<link rel="icon" sizes="32x32" href="https://werner-matthias.github.io/SysOp/assets/img/favicon-32x32.png" />




	
	<link rel="icon" sizes="192x192" href="https://werner-matthias.github.io/SysOp/assets/img/touch-icon-192x192.png" />




	
	<link rel="apple-touch-icon-precomposed" sizes="180x180" href="https://werner-matthias.github.io/SysOp/assets/img/apple-touch-icon-180x180-precomposed.png" />




	
	<link rel="apple-touch-icon-precomposed" sizes="152x152" href="https://werner-matthias.github.io/SysOp/assets/img/apple-touch-icon-152x152-precomposed.png" />




	
	<link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://werner-matthias.github.io/SysOp/assets/img/apple-touch-icon-144x144-precomposed.png" />




	
	<link rel="apple-touch-icon-precomposed" sizes="120x120" href="https://werner-matthias.github.io/SysOp/assets/img/apple-touch-icon-120x120-precomposed.png" />




	
	<link rel="apple-touch-icon-precomposed" sizes="114x114" href="https://werner-matthias.github.io/SysOp/assets/img/apple-touch-icon-114x114-precomposed.png" />




	
	<link rel="apple-touch-icon-precomposed" sizes="76x76" href="https://werner-matthias.github.io/SysOp/assets/img/apple-touch-icon-76x76-precomposed.png" />




	
	<link rel="apple-touch-icon-precomposed" sizes="72x72" href="https://werner-matthias.github.io/SysOp/assets/img/apple-touch-icon-72x72-precomposed.png" />




	
	<link rel="apple-touch-icon-precomposed" href="https://werner-matthias.github.io/SysOp/assets/img/apple-touch-icon-precomposed.png" />	




	
	<meta name="msapplication-TileImage" content="https://werner-matthias.github.io/SysOp/assets/img/msapplication_tileimage.png" />




	
	<meta name="msapplication-TileColor" content="#fabb00" />



	<!-- Facebook Optimization -->
	<meta property="og:locale" content="en_EN" />
	
	<meta property="og:title" content="Reihenfolge" />
	<meta property="og:description" content="Moderne Compiler sind gut in der Lage, Code zu optimieren, so dass viele Performance-Tricks auf der Hochsprachenebene hinfällig geworden sind. Aber manchmal muss man den Compiler auch überzeugen, nicht zuviel des Guten zu tun." />
	<meta property="og:url" content="https://werner-matthias.github.io/SysOp//small/hacks/2017/08/23/reihenfolge/" />
	<meta property="og:site_name" content="Systems Operational" />
	

	

	<!-- Search Engine Optimization -->
	

	<link type="text/plain" rel="author" href="https://werner-matthias.github.io/SysOp/humans.txt" />

	

	
</head>
   <script type="text/javascript"
      src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
   </script>
</head>
<body id="top-of-page" class="page-fullwidth">
	
	
<div id="navigation" class="sticky">
  <nav class="top-bar" role="navigation" data-topbar>
    <ul class="title-area">
      <li class="name">
      <h1 class="show-for-small-only"><a href="https://werner-matthias.github.io/SysOp" class="icon-tree"> Systems Operational</a></h1>
    </li>
       <!-- Remove the class "menu-icon" to get rid of menu icon. Take out "Menu" to just have icon alone -->
      <li class="toggle-topbar menu-icon"><a href="#"><span>Navigation</span></a></li>
    </ul>
    <section class="top-bar-section">

      <ul class="right">
        

              

          
          
        

              

          
          
        

              

          
          
        

              

          
          
            
            
              <li class="divider"></li>
              <li><a href="https://werner-matthias.github.io/SysOp/about/">Über mich</a></li>

            
            
          
        
        
      </ul>

      <ul class="left">
        

              

          
          

            
            
              <li><a href="https://werner-matthias.github.io/SysOp/">Start</a></li>
              <li class="divider"></li>

            
            
          
        

              

          
          

            
            

              <li class="has-dropdown">
                <a href="https://werner-matthias.github.io/SysOp/blog/">Blog</a>

                  <ul class="dropdown">
                    

                      

                      <li><a href="https://werner-matthias.github.io/SysOp/blog/archive/">Archive</a></li>
                    
                  </ul>
                  
              </li>
              <li class="divider"></li>
            
          
        

              

          
          

            
            
              <li><a href="https://werner-matthias.github.io/SysOp/blog/aihpos/">aihPos</a></li>
              <li class="divider"></li>

            
            
          
        

              

          
          
        
        
      </ul>
    </section>
  </nav>
</div><!-- /#navigation -->

	

	

<div id="masthead-no-image-header">
	<div class="row">
		<div class="small-12 columns">
			<a id="logo" href="https://werner-matthias.github.io/SysOp" title="Systems Operational – Matthias Werners selten gepflegtes Blog über Computer und Menschen">
				<img src="https://werner-matthias.github.io/SysOp/assets/img/logo.png" alt="Systems Operational – Matthias Werners selten gepflegtes Blog über Computer und Menschen">
			</a>
		</div><!-- /.small-12.columns -->
	</div><!-- /.row -->
</div><!-- /#masthead -->









	


<div class="row t30">
	<div class="medium-12 columns">
		<article>
			<header>
				
				<h1>Reihenfolge</h1>
			</header>

			

			<span itemprop="articleSection">
	                <p>Bei <a href="/blog/ahipos"><img alt="aihPOS" style="height:.78em; vertical-align:baseline" src="/SysOp/assets/img/sophia.png"></a> hatte ich diesr Tage das Phänomen, dass Code, der in der Debugging-Version tadellos lief, in der Release-Version abstürzte. Der Unterschied zwischen beiden Versionen ist – da ich die Debugsymbole nicht ins Binärfile übernommen hatte[^1]– lediglich die Optimierung.</p>

<p>Nach längerer Fehlersuche stellte sich folgende Funktion als Verursacherin heraus:</p>
<div class="language-rust highlighter-rouge"><pre class="highlight"><code><span class="err">#</span><span class="p">[</span><span class="nf">inline</span><span class="p">(</span><span class="n">never</span><span class="p">)]</span>
<span class="k">fn</span> <span class="nf">init_stacks</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">let</span> <span class="n">adr</span> <span class="o">=</span> <span class="nf">determine_irq_stack</span><span class="p">();</span>
    <span class="nn">Cpu</span><span class="p">::</span><span class="nf">set_mode</span><span class="p">(</span><span class="nn">ProcessorMode</span><span class="p">::</span><span class="n">Irq</span><span class="p">);</span>
    <span class="nn">Cpu</span><span class="p">::</span><span class="nf">set_stack</span><span class="p">(</span><span class="n">adr</span><span class="p">);</span>
    <span class="nn">Cpu</span><span class="p">::</span><span class="nf">set_mode</span><span class="p">(</span><span class="nn">ProcessorMode</span><span class="p">::</span><span class="n">Fiq</span><span class="p">);</span>
    <span class="nn">Cpu</span><span class="p">::</span><span class="nf">set_stack</span><span class="p">(</span><span class="n">adr</span><span class="p">);</span>
    <span class="nn">Cpu</span><span class="p">::</span><span class="nf">set_mode</span><span class="p">(</span><span class="nn">ProcessorMode</span><span class="p">::</span><span class="n">Abort</span><span class="p">);</span>
    <span class="nn">Cpu</span><span class="p">::</span><span class="nf">set_stack</span><span class="p">(</span><span class="n">adr</span><span class="p">);</span>
    <span class="nn">Cpu</span><span class="p">::</span><span class="nf">set_mode</span><span class="p">(</span><span class="nn">ProcessorMode</span><span class="p">::</span><span class="n">Undef</span><span class="p">);</span>
    <span class="nn">Cpu</span><span class="p">::</span><span class="nf">set_stack</span><span class="p">(</span><span class="n">adr</span><span class="p">);</span>
    <span class="c">// ...und zurück in den Svc-Mode</span>
    <span class="nn">Cpu</span><span class="p">::</span><span class="nf">set_mode</span><span class="p">(</span><span class="nn">ProcessorMode</span><span class="p">::</span><span class="n">Svc</span><span class="p">);</span>
<span class="p">}</span>
</code></pre>
</div>
<p>Das war etwas verwunderlich, da sowohl <code class="highlighter-rouge">Cpu::set_mode()</code> als auch <code class="highlighter-rouge">Cpu::set_stack()</code> jeweils nur einen Assembler-Befehl erzeugen sollten:</p>
<div class="language-rust highlighter-rouge"><pre class="highlight"><code>    <span class="c">/// Setzt Prozessormodus</span>
    <span class="cp">#[inline(always)]</span>
    <span class="k">pub</span> <span class="k">fn</span> <span class="nf">set_mode</span><span class="p">(</span><span class="n">mode</span><span class="p">:</span> <span class="n">ProcessorMode</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">unsafe</span><span class="p">{</span>
            <span class="k">match</span> <span class="n">mode</span> <span class="p">{</span>
                <span class="nn">ProcessorMode</span><span class="p">::</span><span class="n">User</span> <span class="k">=&gt;</span>   <span class="nd">asm!</span><span class="p">(</span><span class="s">"cps 0x10"</span><span class="p">),</span>
                <span class="nn">ProcessorMode</span><span class="p">::</span><span class="n">Fiq</span> <span class="k">=&gt;</span>    <span class="nd">asm!</span><span class="p">(</span><span class="s">"cps 0x11"</span><span class="p">),</span>
                <span class="nn">ProcessorMode</span><span class="p">::</span><span class="n">Irq</span> <span class="k">=&gt;</span>    <span class="nd">asm!</span><span class="p">(</span><span class="s">"cps 0x12"</span><span class="p">),</span>
                <span class="nn">ProcessorMode</span><span class="p">::</span><span class="n">Svc</span> <span class="k">=&gt;</span>    <span class="nd">asm!</span><span class="p">(</span><span class="s">"cps 0x13"</span><span class="p">),</span>
                <span class="nn">ProcessorMode</span><span class="p">::</span><span class="n">Abort</span> <span class="k">=&gt;</span>  <span class="nd">asm!</span><span class="p">(</span><span class="s">"cps 0x17"</span><span class="p">),</span>
                <span class="nn">ProcessorMode</span><span class="p">::</span><span class="n">Undef</span> <span class="k">=&gt;</span>  <span class="nd">asm!</span><span class="p">(</span><span class="s">"cps 0x1B"</span><span class="p">),</span>
                <span class="nn">ProcessorMode</span><span class="p">::</span><span class="n">System</span> <span class="k">=&gt;</span> <span class="nd">asm!</span><span class="p">(</span><span class="s">"cps 0x1F"</span><span class="p">),</span>
            <span class="p">};</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c">/// Setzt das Stack-Register </span>
    <span class="cp">#[inline(always)]</span>
    <span class="k">pub</span> <span class="k">fn</span> <span class="nf">set_stack</span><span class="p">(</span><span class="n">adr</span><span class="p">:</span> <span class="n">Address</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">unsafe</span><span class="p">{</span>
            <span class="nd">asm!</span><span class="p">(</span><span class="s">"mov sp, $0"</span><span class="p">::</span><span class="s">"r"</span><span class="p">(</span><span class="n">adr</span><span class="p">)::</span><span class="s">"volatile"</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
</code></pre>
</div>
<p>Der Blick auf den generierten Assembler-Code (via <kbd>objdump</kbd>) zeigt das Problem. Während die Debug-Version so aussah …</p>
<pre><code class="language-asm"> 000006b4 &lt;_ZN13aihpos_kernel11init_stacks17hbe91fb6176eaf21dE&gt;:
     6b4:	e92d4800 	push	{fp, lr}
     6b8:	e1a0b00d 	mov	fp, sp
     6bc:	ebffffba 	bl	5ac &lt;_ZN13aihpos_kernel19determine_irq_stack17h107193fbe9f3e16eE&gt;
     6c0:	f1020012 	cps	#18
     6c4:	e1a0d000 	mov	sp, r0
     6c8:	f1020011 	cps	#17
     6cc:	e1a0d000 	mov	sp, r0
     6d0:	f1020017 	cps	#23
     6d4:	e1a0d000 	mov	sp, r0
     6d8:	f102001b 	cps	#27
     6dc:	e1a0d000 	mov	sp, r0
     6e0:	f1020013 	cps	#19
     6e4:	e8bd8800 	pop	{fp, pc}
</code></pre>
<p>… lautete die optimierte Version so;</p>
<pre><code class="language-asm">000010bc &lt;_ZN13aihpos_kernel11init_stacks17h0c7ec04f5f8147a7E&gt;:
    10bc:	e92d4800 	push	{fp, lr}
    10c0:	ebfffe4d 	bl	9fc &lt;_ZN13aihpos_kernel19determine_irq_stack17hc16efbf461b228f8E&gt;
    10c4:	e1a0d000 	mov	sp, r0
    10c8:	f1020012 	cps	#18
    10cc:	f1020011 	cps	#17
    10d0:	f1020017 	cps	#23
    10d4:	f102001b 	cps	#27
    10d8:	f1020013 	cps	#19
    10dc:	e1a0d000 	mov	sp, r0
    10e0:	e1a0d000 	mov	sp, r0
    10e4:	e1a0d000 	mov	sp, r0
    10e8:	e8bd8800 	pop	{fp, pc}
</code></pre>

<p>Der Optimierer hatte also die Befehle umgeordnet. Warum er das für <em>besser</em> hielt, ist mir nicht ganz klar. Dass er es allerdings glaubt zu <em>dürfen</em>, liegt daran, dass <code class="highlighter-rouge">cps</code> für ihn kein Lese- oder Schreibebefehl ist, so dass er keine Datenabhängigkeit sah.</p>

<p>Zur Behebung dieses Problems genügt der alte Trick, eine Abhängigkeit zu behaupten. Jetzt sieht der <code class="highlighter-rouge">set_mode()</code>-Code so aus:</p>

<div class="language-rust highlighter-rouge"><pre class="highlight"><code>    <span class="err">#</span><span class="p">[</span><span class="nf">inline</span><span class="p">(</span><span class="n">always</span><span class="p">)]</span>
    <span class="k">pub</span> <span class="k">fn</span> <span class="nf">set_mode</span><span class="p">(</span><span class="n">mode</span><span class="p">:</span> <span class="n">ProcessorMode</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">unsafe</span><span class="p">{</span>
            <span class="k">match</span> <span class="n">mode</span> <span class="p">{</span>
                <span class="nn">ProcessorMode</span><span class="p">::</span><span class="n">User</span> <span class="k">=&gt;</span>   <span class="nd">asm!</span><span class="p">(</span><span class="s">"cps 0x10"</span><span class="p">:::</span><span class="s">"memory"</span><span class="p">:),</span>
                <span class="nn">ProcessorMode</span><span class="p">::</span><span class="n">Fiq</span> <span class="k">=&gt;</span>    <span class="nd">asm!</span><span class="p">(</span><span class="s">"cps 0x11"</span><span class="p">:::</span><span class="s">"memory"</span><span class="p">:),</span>
                <span class="nn">ProcessorMode</span><span class="p">::</span><span class="n">Irq</span> <span class="k">=&gt;</span>    <span class="nd">asm!</span><span class="p">(</span><span class="s">"cps 0x12"</span><span class="p">:::</span><span class="s">"memory"</span><span class="p">:),</span>
                <span class="nn">ProcessorMode</span><span class="p">::</span><span class="n">Svc</span> <span class="k">=&gt;</span>    <span class="nd">asm!</span><span class="p">(</span><span class="s">"cps 0x13"</span><span class="p">:::</span><span class="s">"memory"</span><span class="p">:),</span>
                <span class="nn">ProcessorMode</span><span class="p">::</span><span class="n">Abort</span> <span class="k">=&gt;</span>  <span class="nd">asm!</span><span class="p">(</span><span class="s">"cps 0x17"</span><span class="p">:::</span><span class="s">"memory"</span><span class="p">:),</span>
                <span class="nn">ProcessorMode</span><span class="p">::</span><span class="n">Undef</span> <span class="k">=&gt;</span>  <span class="nd">asm!</span><span class="p">(</span><span class="s">"cps 0x1B"</span><span class="p">:::</span><span class="s">"memory"</span><span class="p">:),</span>
                <span class="nn">ProcessorMode</span><span class="p">::</span><span class="n">System</span> <span class="k">=&gt;</span> <span class="nd">asm!</span><span class="p">(</span><span class="s">"cps 0x1F"</span><span class="p">:::</span><span class="s">"memory"</span><span class="p">:),</span>
            <span class="p">};</span>
        <span class="p">}</span>
    <span class="p">}</span>
</code></pre>
</div>
<p>Der vierte Parameter im <code class="highlighter-rouge">asm!()</code>-Macro sagt normalerweise, welche Register „verschmutzt“ werden, so dass der Compiler sich nicht darauf verlassen darf, dass deren Inhalte gleich bleiben. Man kann dort aber auch „memory“ hinschreiben, was behauptet, dass der Assember-Code Nebeneffekte hat. Damit darf der Compiler die Reihenfolge nicht mehr ändern, und <img alt="aihPOS" style="height:.78em; vertical-align:baseline" src="/SysOp/assets/img/sophia.png"> funktioniert auch mit <code class="highlighter-rouge">--opt-level=3</code>.</p>

<p>[^1] Die Symbole nützten mir auf dem Raspberry Pi nichts, da das Debugging über den Entwicklungsrechner läuft.</p>

	                </span>
			
						<div id="page-meta" class="t30">
				<p>
					<!-- Look the author details up from the site config. -->
					
					<!-- Output author details if some exist. -->
					
					<span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name" class="pr20 icon-edit"><a href="http://osg.informatik.tu-chemnitz.de/Staff/M_Werner/index.php?lang=en" target="_blank"> Matthias Werner</a></span>
				</span>
				

				
				<time class="icon-calendar pr20" datetime="2017-08-23" itemprop="datePublished"> 2017-08-23</time>
				

				<span class="icon-archive pr20"> SMALL · HACKS</span>
				<br />
				<span class="pr20"></span>
			</p>

			<div id="post-nav" class="row">
				
				<div class="small-5 columns"><a class="button small radius prev" href="https://werner-matthias.github.io/SysOp/aihpos/2017/07/18/aihpos-braking-news/">&laquo; Braking News</a></div><!-- /.small-4.columns -->
				
				<div class="small-2 columns text-center"><a class="radius button small" href="https://werner-matthias.github.io/SysOp/blog/archive/" title="Blog Archiv">Archiv</a></div><!-- /.small-4.columns -->
				
			</div>
			</div><!--  /.page-meta -->
			

	                
		</article>
	</div><!-- /.medium-12.columns -->
</div><!-- /.row -->




	
	    <div id="up-to-top" class="row">
      <div class="small-12 columns" style="text-align: right;">
        <a class="iconfont" href="#top-of-page">&#xf108;</a>
      </div><!-- /.small-12.columns -->
    </div><!-- /.row -->


    <footer id="footer-content" class="bg-grau">
      <div id="footer">
        <div class="row">
          <div class="medium-6 large-5 columns">
            <h5 class="shadow-black">Über diese Website</h5>

            <p class="shadow-black">
              Matthias Werners Blog. 
              <a href="https://werner-matthias.github.io/SysOp/info/">Mehr ›</a>
            </p>
          </div><!-- /.large-6.columns -->


          <div class="small-6 medium-3 large-3 large-offset-1 columns">
            
              
              <ul class="no-bullet shadow-black">
              
              </ul>
          </div><!-- /.large-4.columns -->


          <div class="small-6 medium-3 large-3 columns">
            
              
            <ul class="no-bullet shadow-black">
            
            </ul>
          </div><!-- /.large-3.columns -->
        </div><!-- /.row -->

      </div><!-- /#footer -->

    </footer>

	

	


<script src="https://werner-matthias.github.io/SysOp/assets/js/javascript.min.js"></script>














</body>
</html>

