<!doctype html>
<html class="no-js" lang="de">
<head>
		<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>Braking News</title>
	<link rel="stylesheet" type="text/css" href="http://localhost:4000/assets/css/styles_feeling_responsive.css" />
	<script src="http://localhost:4000/assets/js/modernizr.min.js"></script>

  <script src="https://ajax.googleapis.com/ajax/libs/webfont/1.5.18/webfont.js"></script>
  <script>
    WebFont.load({
      google: {
        families: [ 'Lato:400,700,400italic:latin', 'Volkhov::latin' ]
      }
    });
  </script>

  <noscript>
    <link href='http://fonts.googleapis.com/css?family=Lato:400,700,400italic|Volkhov' rel='stylesheet' type='text/css' />
  </noscript>

  
	
	<meta name="description" content="So ist das mit &quot;unstable&quot; Versionen: Kaum kommt man nach zwei Wochen von einer Reise zurück, schon funktioniert die Übersetzung nicht mehr - in diesem ist Fall der Heap kaputt. "/>

	

	



	
	<link rel="icon" sizes="32x32" href="http://localhost:4000/assets/img/favicon-32x32.png" />




	
	<link rel="icon" sizes="192x192" href="http://localhost:4000/assets/img/touch-icon-192x192.png" />




	
	<link rel="apple-touch-icon-precomposed" sizes="180x180" href="http://localhost:4000/assets/img/apple-touch-icon-180x180-precomposed.png" />




	
	<link rel="apple-touch-icon-precomposed" sizes="152x152" href="http://localhost:4000/assets/img/apple-touch-icon-152x152-precomposed.png" />




	
	<link rel="apple-touch-icon-precomposed" sizes="144x144" href="http://localhost:4000/assets/img/apple-touch-icon-144x144-precomposed.png" />




	
	<link rel="apple-touch-icon-precomposed" sizes="120x120" href="http://localhost:4000/assets/img/apple-touch-icon-120x120-precomposed.png" />




	
	<link rel="apple-touch-icon-precomposed" sizes="114x114" href="http://localhost:4000/assets/img/apple-touch-icon-114x114-precomposed.png" />




	
	<link rel="apple-touch-icon-precomposed" sizes="76x76" href="http://localhost:4000/assets/img/apple-touch-icon-76x76-precomposed.png" />




	
	<link rel="apple-touch-icon-precomposed" sizes="72x72" href="http://localhost:4000/assets/img/apple-touch-icon-72x72-precomposed.png" />




	
	<link rel="apple-touch-icon-precomposed" href="http://localhost:4000/assets/img/apple-touch-icon-precomposed.png" />	




	
	<meta name="msapplication-TileImage" content="http://localhost:4000/assets/img/msapplication_tileimage.png" />




	
	<meta name="msapplication-TileColor" content="#fabb00" />



	<!-- Facebook Optimization -->
	<meta property="og:locale" content="en_EN" />
	
	<meta property="og:title" content="Braking News" />
	<meta property="og:description" content="So ist das mit &quot;unstable&quot; Versionen: Kaum kommt man nach zwei Wochen von einer Reise zurück, schon funktioniert die Übersetzung nicht mehr - in diesem ist Fall der Heap kaputt. " />
	<meta property="og:url" content="http://localhost:4000//aihpos/aihpos-braking-news/" />
	<meta property="og:site_name" content="Systems Operational" />
	

	

	<!-- Search Engine Optimization -->
	

	<link type="text/plain" rel="author" href="http://localhost:4000/humans.txt" />

	

	
</head>
</head>
<body id="top-of-page" class="page-fullwidth">
	
	
<div id="navigation" class="sticky">
  <nav class="top-bar" role="navigation" data-topbar>
    <ul class="title-area">
      <li class="name">
      <h1 class="show-for-small-only"><a href="http://localhost:4000" class="icon-tree"> Systems Operational</a></h1>
    </li>
       <!-- Remove the class "menu-icon" to get rid of menu icon. Take out "Menu" to just have icon alone -->
      <li class="toggle-topbar menu-icon"><a href="#"><span>Navigation</span></a></li>
    </ul>
    <section class="top-bar-section">

      <ul class="right">
        

              

          
          
        

              

          
          
        

              

          
          
        

              

          
          
            
            
              <li class="divider"></li>
              <li><a href="http://localhost:4000/about/">Über mich</a></li>

            
            
          
        
        
      </ul>

      <ul class="left">
        

              

          
          

            
            
              <li><a href="http://localhost:4000/">Start</a></li>
              <li class="divider"></li>

            
            
          
        

              

          
          

            
            

              <li class="has-dropdown">
                <a href="http://localhost:4000/blog/">Blog</a>

                  <ul class="dropdown">
                    

                      

                      <li><a href="http://localhost:4000/blog/archive/">Archive</a></li>
                    
                  </ul>
                  
              </li>
              <li class="divider"></li>
            
          
        

              

          
          

            
            
              <li><a href="http://localhost:4000/blog/aihpos/">aihPos</a></li>
              <li class="divider"></li>

            
            
          
        

              

          
          
        
        
      </ul>
    </section>
  </nav>
</div><!-- /#navigation -->

	

	

<div id="masthead-no-image-header">
	<div class="row">
		<div class="small-12 columns">
			<a id="logo" href="http://localhost:4000" title="Systems Operational – Matthias Werners selten gepflegtes Blog über Computer und Menschen">
				<img src="http://localhost:4000/assets/img/logo.png" alt="Systems Operational – Matthias Werners selten gepflegtes Blog über Computer und Menschen">
			</a>
		</div><!-- /.small-12.columns -->
	</div><!-- /.row -->
</div><!-- /#masthead -->









	


<div class="row t30">
	<div class="medium-12 columns">
		<article>
			<header>
				<p class="subheadline">aihPOS - Ein Betriebsystem für die Lehre</p>
				<h1>Braking News</h1>
			</header>

			

			<span itemprop="articleSection">
	                <p><strong>Inhalt</strong></p>
<ul id="markdown-toc">
  <li><a href="#sophia-wir-haben-ein-problem" id="markdown-toc-sophia-wir-haben-ein-problem"><img alt="aihPOS" style="height:.78em; vertical-align:baseline" src="/SysOp/assets/img/sophia.png">, wir haben ein Problem</a>    <ul>
      <li><a href="#missing-feature" id="markdown-toc-missing-feature">Missing Feature</a></li>
      <li><a href="#auf-der-suche-nach-dem-verlorenen-attribut" id="markdown-toc-auf-der-suche-nach-dem-verlorenen-attribut">Auf der Suche nach dem verlorenen Attribut</a></li>
    </ul>
  </li>
  <li><a href="#auf-zu-neuen-ufern" id="markdown-toc-auf-zu-neuen-ufern">Auf zu neuen Ufern</a>    <ul>
      <li><a href="#allokator-api" id="markdown-toc-allokator-api">Allokator-API</a></li>
      <li><a href="#guter-service" id="markdown-toc-guter-service">Guter Service</a></li>
    </ul>
  </li>
</ul>

<p><a class="left button tiny radius" href="http://localhost:4000/aihpos/aihpos-vm/"><span class="icon-chevron-left"></span>Vorheriger Beitrag in AIHPOS</a></p>

<div class="row"></div>

<h2 id="sophia-wir-haben-ein-problem"><img alt="aihPOS" style="height:.78em; vertical-align:baseline" src="/SysOp/assets/img/sophia.png">, wir haben ein Problem</h2>
<h3 id="missing-feature">Missing Feature</h3>
<p>Für fast zwei Wochen war ich in Bulgarien. Danach erhielt ich beim ersten Übersetzungsversuch des <img alt="aihPOS" style="height:.78em; vertical-align:baseline" src="/SysOp/assets/img/sophia.png">-Codes eine Fehlermeldung:</p>
<div class="window">
          <nav class="control-window">
            <a href="#finder" class="close" data-rel="close">close</a>
            <a href="#" class="minimize">minimize</a>
            <a href="#" class="deactivate">deactivate</a>
          </nav>
          <h1 class="titleInside">Terminal</h1>
          <div class="container"><div class="terminal"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">&nbsp;</span>
<span class="line-number">&nbsp;</span>
<span class="line-number">&nbsp;</span>
<span class="line-number">&nbsp;</span>
<span class="line-number">&nbsp;</span>
<span class="line-number">&nbsp;</span>
<span class="line-number">&nbsp;</span>
<span class="line-number">&nbsp;</span>
<span class="line-number">&nbsp;</span>
<span class="line-number">&nbsp;</span>
<span class="line-number">&nbsp;</span>
<span class="line-number">&nbsp;</span>
<span class="line-number">&nbsp;</span>
<span class="line-number">&nbsp;</span>
<span class="line-number">&nbsp;</span></pre></td><td class="code"><pre><code><span class="line output">error[E0557]: feature has been removed
</span><span class="line output"> --&gt; libs/kalloc/src/lib.rs:1:12
</span><span class="line output">  |
</span><span class="line output">1 | #![feature(allocator)] 
</span><span class="line output">  |            ^^^^^^^^^
</span><span class="line output">
</span><span class="line output">error: The attribute `allocator` is currently unknown to the compiler and may have meaning added to it in the future (see issue #29642)
</span><span class="line output"> --&gt; libs/kalloc/src/lib.rs:2:1
</span><span class="line output">  |
</span><span class="line output">2 | #![allocator]
</span><span class="line output">  | ^^^^^^^^^^^^^
</span><span class="line output">  |
</span><span class="line output">  = help: add #![feature(custom_attribute)] to the crate attributes to enable
</span><span class="line output">
</span><span class="line output">error: aborting due to 2 previous errors</span></code></pre></td></tr></table></div></div>
        </div>

<p>Natürlich fiel die Fehlermeldung nicht einfach so vom Himmel, ich hatte vorher – wie ich das regelmäßig tue – meine Toolchain mit <code class="highlighter-rouge">rustup update</code> aktualisiert.
Selbstverständlich hätte ich jetzt meine Toolchain auch wieder zurück setzen können, aber ich möchte, dass <img alt="aihPOS" style="height:.78em; vertical-align:baseline" src="/SysOp/assets/img/sophia.png"> mit der jeweilig aktuellen Toolchain übersetzbar ist.
Und da ich „nightly“ nutze, können solche abrupten Wechsel schon mal vorkommen. Also wird erstmal nichts aus der Erweiterung unseres Betriebssystem, sondern es heißt, den bestehenden Code wieder
lauffähig zu machen.</p>

<h3 id="auf-der-suche-nach-dem-verlorenen-attribut">Auf der Suche nach dem verlorenen Attribut</h3>
<p>Wie die Fehlermeldung angibt, wurde das Feature <code class="highlighter-rouge">#![allocator]</code> entfernt. Was nun? Ein <code class="highlighter-rouge">rustc --explain E0557</code> hilft hier nicht weiter, und das angegebene Issue in GitHub
beschäftigt sich mit Customer-Attributen. Vielleicht braucht man das Attribut nicht mehr, es reicht, dass die Funktionen vorhanden sind?
Ein einfaches Auskommentieren hilft nicht:</p>
<div class="window">
          <nav class="control-window">
            <a href="#finder" class="close" data-rel="close">close</a>
            <a href="#" class="minimize">minimize</a>
            <a href="#" class="deactivate">deactivate</a>
          </nav>
          <h1 class="titleInside">Terminal</h1>
          <div class="container"><div class="terminal"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">&nbsp;</span>
<span class="line-number">&nbsp;</span>
<span class="line-number">&nbsp;</span>
<span class="line-number">&nbsp;</span>
<span class="line-number">&nbsp;</span></pre></td><td class="code"><pre><code><span class="line output">error: no #[default_lib_allocator] found but one is required; is libstd not linked?
</span><span class="line output">
</span><span class="line output">error: cannot continue compilation due to previous error
</span><span class="line output">
</span><span class="line output">error: Could not compile `aihPOS`.</span></code></pre></td></tr></table></div></div>
        </div>
<p>Aha, sollte das Attribut einfach bloß umbenannt worden sein? Leider nein, <code class="highlighter-rouge">#![allocator]</code> war ein modulweites Attribut, im Gegensatz zu <code class="highlighter-rouge">#[default_lib_allocator]</code>. Im
„<a href="https://doc.rust-lang.org/unstable-book/">Unstable Book</a>“ ist <code class="highlighter-rouge">#[default_lib_allocator]</code> nicht aufgeführt. Allerdings hilft der
GitHup-<a href="https://github.com/rust-lang/rust/issues/27389">Issue</a> zu  <code class="highlighter-rouge">#![allocator]</code> weiter: Es verweist auf einen anderen Issue,
<a href="https://github.com/rust-lang/rust/pull/42727">#42727</a>, der wiederum auf anderes verweist, u.a. Issue <a href="https://github.com/rust-lang/rust/issues/32838">#32838</a> und
die RFCs <a href="https://github.com/rust-lang/rfcs/blob/master/text/1974-global-allocators.md">RFC 1974</a> und
<a href="https://github.com/rust-lang/rfcs/blob/master/text/1398-kinds-of-allocators.md">RFC 1398</a>. Daraus ergibt sich ein stimmiges Bild: Das Allokator-Interface wurde
überarbeitet und durch eine neue API ersetzt.</p>

<p>Im Folgendem wird beschrieben, wie das Allokator-Interface nun aussieht. Die entsprechenden Aussagen aus der Folge <a href="/aihpos/aihpos-heap/">„Wir machen einen Haufen“</a> dieser
Reihe sind als überholt zu betrachten.</p>

<h2 id="auf-zu-neuen-ufern">Auf zu neuen Ufern</h2>
<h3 id="allokator-api">Allokator-API</h3>
<p>Ein Allokator (im allgemeinen) ist eine Struktur, die den <code class="highlighter-rouge">Allocator</code>-Trait implementiert. Der Trait ist zwar im Crate <code class="highlighter-rouge">alloc</code> definiert, aber derzeit<sup id="fnref:1"><a href="#fn:1" class="footnote">1</a></sup>
noch nicht in der offiziellen <a href="https://doc.rust-lang.org/alloc/index.html">Dokumentation</a>. Die Quellfiles sind aber ausführlich kommentiert.</p>

<p>Der Trait besteht aus folgenden Funktionen:</p>
<div class="language-rust highlighter-rouge"><pre class="highlight"><code><span class="k">pub</span> <span class="k">unsafe</span> <span class="k">trait</span> <span class="n">Allocator</span> <span class="p">{</span>
    <span class="k">unsafe</span> <span class="k">fn</span> <span class="nf">alloc</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="k">self</span><span class="p">,</span> <span class="n">layout</span><span class="p">:</span> <span class="n">Layout</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="n">Result</span><span class="o">&lt;*</span><span class="k">mut</span> <span class="nb">u8</span><span class="p">,</span> <span class="n">AllocErr</span><span class="o">&gt;</span><span class="p">;</span>

    <span class="k">unsafe</span> <span class="k">fn</span> <span class="nf">dealloc</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="k">self</span><span class="p">,</span> <span class="n">ptr</span><span class="p">:</span> <span class="o">*</span><span class="k">mut</span> <span class="nb">u8</span><span class="p">,</span> <span class="n">layout</span><span class="p">:</span> <span class="n">Layout</span><span class="p">);</span>
	
    <span class="k">fn</span> <span class="nf">oom</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="k">self</span><span class="p">,</span> <span class="n">_</span><span class="p">:</span> <span class="n">AllocErr</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="o">!</span><span class="p">;</span>
	
    <span class="k">fn</span> <span class="nf">usable_size</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="p">,</span> <span class="n">layout</span><span class="p">:</span> <span class="o">&amp;</span><span class="n">Layout</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="p">(</span><span class="nb">usize</span><span class="p">,</span> <span class="nb">usize</span><span class="p">);</span>
	
    <span class="k">unsafe</span> <span class="k">fn</span> <span class="nf">realloc</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="k">self</span><span class="p">,</span>
                      <span class="n">ptr</span><span class="p">:</span> <span class="o">*</span><span class="k">mut</span> <span class="nb">u8</span><span class="p">,</span>
                      <span class="n">layout</span><span class="p">:</span> <span class="n">Layout</span><span class="p">,</span>
                      <span class="n">new_layout</span><span class="p">:</span> <span class="n">Layout</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="n">Result</span><span class="o">&lt;*</span><span class="k">mut</span> <span class="nb">u8</span><span class="p">,</span> <span class="n">AllocErr</span><span class="o">&gt;</span><span class="p">;</span>
					  
    <span class="k">unsafe</span> <span class="k">fn</span> <span class="nf">alloc_zeroed</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="k">self</span><span class="p">,</span> <span class="n">layout</span><span class="p">:</span> <span class="n">Layout</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="n">Result</span><span class="o">&lt;*</span><span class="k">mut</span> <span class="nb">u8</span><span class="p">,</span> <span class="n">AllocErr</span><span class="o">&gt;</span><span class="p">;</span>
					  
    <span class="k">unsafe</span> <span class="k">fn</span> <span class="nf">alloc_excess</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="k">self</span><span class="p">,</span> <span class="n">layout</span><span class="p">:</span> <span class="n">Layout</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="n">Result</span><span class="o">&lt;</span><span class="n">Excess</span><span class="p">,</span> <span class="n">AllocErr</span><span class="o">&gt;</span><span class="p">;</span>
	
    <span class="k">unsafe</span> <span class="k">fn</span> <span class="nf">realloc_excess</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="k">self</span><span class="p">,</span>
                             <span class="n">ptr</span><span class="p">:</span> <span class="o">*</span><span class="k">mut</span> <span class="nb">u8</span><span class="p">,</span>
                             <span class="n">layout</span><span class="p">:</span> <span class="n">Layout</span><span class="p">,</span>
                             <span class="n">new_layout</span><span class="p">:</span> <span class="n">Layout</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="n">Result</span><span class="o">&lt;</span><span class="n">Excess</span><span class="p">,</span> <span class="n">AllocErr</span><span class="o">&gt;</span><span class="p">;</span>
							 
    <span class="k">unsafe</span> <span class="k">fn</span> <span class="nf">grow_in_place</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="k">self</span><span class="p">,</span>
                            <span class="n">ptr</span><span class="p">:</span> <span class="o">*</span><span class="k">mut</span> <span class="nb">u8</span><span class="p">,</span>
                            <span class="n">layout</span><span class="p">:</span> <span class="n">Layout</span><span class="p">,</span>
                            <span class="n">new_layout</span><span class="p">:</span> <span class="n">Layout</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="n">Result</span><span class="o">&lt;</span><span class="p">(),</span> <span class="n">CannotReallocInPlace</span><span class="o">&gt;</span><span class="p">;</span>
							
    <span class="k">unsafe</span> <span class="k">fn</span> <span class="nf">shrink_in_place</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="k">self</span><span class="p">,</span>
                              <span class="n">ptr</span><span class="p">:</span> <span class="o">*</span><span class="k">mut</span> <span class="nb">u8</span><span class="p">,</span>
                              <span class="n">layout</span><span class="p">:</span> <span class="n">Layout</span><span class="p">,</span>
                              <span class="n">new_layout</span><span class="p">:</span> <span class="n">Layout</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="n">Result</span><span class="o">&lt;</span><span class="p">(),</span> <span class="n">CannotReallocInPlace</span><span class="o">&gt;</span><span class="p">;</span>

    <span class="k">fn</span> <span class="n">alloc_one</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="k">self</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="n">Result</span><span class="o">&lt;</span><span class="n">Unique</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">AllocErr</span><span class="o">&gt;</span>
        <span class="n">where</span> <span class="n">Self</span><span class="p">:</span> <span class="n">Sized</span><span class="p">;</span>
	
    <span class="k">unsafe</span> <span class="k">fn</span> <span class="n">dealloc_one</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="k">self</span><span class="p">,</span> <span class="n">ptr</span><span class="p">:</span> <span class="n">Unique</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">)</span>
        <span class="n">where</span> <span class="n">Self</span><span class="p">:</span> <span class="n">Sized</span><span class="p">;</span>

    <span class="k">fn</span> <span class="n">alloc_array</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="k">self</span><span class="p">,</span> <span class="n">n</span><span class="p">:</span> <span class="nb">usize</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="n">Result</span><span class="o">&lt;</span><span class="n">Unique</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">AllocErr</span><span class="o">&gt;</span>
        <span class="n">where</span> <span class="n">Self</span><span class="p">:</span> <span class="n">Sized</span><span class="p">;</span>

    <span class="k">unsafe</span> <span class="k">fn</span> <span class="n">realloc_array</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="k">self</span><span class="p">,</span>
                               <span class="n">ptr</span><span class="p">:</span> <span class="n">Unique</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">,</span>
                               <span class="n">n_old</span><span class="p">:</span> <span class="nb">usize</span><span class="p">,</span>
                               <span class="n">n_new</span><span class="p">:</span> <span class="nb">usize</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="n">Result</span><span class="o">&lt;</span><span class="n">Unique</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">AllocErr</span><span class="o">&gt;</span>
        <span class="n">where</span> <span class="n">Self</span><span class="p">:</span> <span class="n">Sized</span><span class="p">;</span>

    <span class="k">unsafe</span> <span class="k">fn</span> <span class="n">dealloc_array</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="k">self</span><span class="p">,</span> <span class="n">ptr</span><span class="p">:</span> <span class="n">Unique</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">n</span><span class="p">:</span> <span class="nb">usize</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="n">Result</span><span class="o">&lt;</span><span class="p">(),</span> <span class="n">AllocErr</span><span class="o">&gt;</span>
        <span class="n">where</span> <span class="n">Self</span><span class="p">:</span> <span class="n">Sized</span><span class="p">;</span>
<span class="p">}</span>
</code></pre>
</div>
<p>Müssen jetzt wirklich fünfzehn Funktionen implementiert werden? Und die neuen Typen, <code class="highlighter-rouge">Layout</code>, <code class="highlighter-rouge">AllocErr</code>, <code class="highlighter-rouge">Excess</code>, <code class="highlighter-rouge">CannotReallocInPlace</code>?
Tatsächlich sieht die Sache viel freundlicher aus: Nur zwei der Funktionen sind obligatorisch, nämlich <code class="highlighter-rouge">alloc()</code> und <code class="highlighter-rouge">dealloc()</code>. Alle anderen haben sinnvolle
Standardimplementationen (<em>defaults</em>).</p>

<p><code class="highlighter-rouge">Layout</code> ist eine Struktur, die einen Speicherrequest beschreibt. Sie hat u.a. die beiden Methoden:</p>
<div class="language-rust highlighter-rouge"><pre class="highlight"><code><span class="k">pub</span> <span class="k">fn</span> <span class="nf">size</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="nb">usize</span><span class="p">;</span>
</code></pre>
</div>
<p>und</p>
<div class="language-rust highlighter-rouge"><pre class="highlight"><code><span class="k">pub</span> <span class="k">fn</span> <span class="nf">align</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="nb">usize</span><span class="p">;</span>
</code></pre>
</div>

<p>Der Summentyp<sup id="fnref:2"><a href="#fn:2" class="footnote">2</a></sup> <code class="highlighter-rouge">AllocErr</code> ist – wie der Name vorschlägt – für den Fehlerbericht bei der Allozierung zuständig. Er ist wie folgt definiert:</p>
<div class="language-rust highlighter-rouge"><pre class="highlight"><code><span class="err">#</span><span class="p">[</span><span class="nf">derive</span><span class="p">(</span><span class="n">Clone</span><span class="p">,</span> <span class="n">PartialEq</span><span class="p">,</span> <span class="nb">Eq</span><span class="p">,</span> <span class="n">Debug</span><span class="p">)]</span>
<span class="k">pub</span> <span class="k">enum</span> <span class="n">AllocErr</span> <span class="p">{</span>
    <span class="n">Exhausted</span> <span class="p">{</span> <span class="n">request</span><span class="p">:</span> <span class="n">Layout</span> <span class="p">},</span>
    <span class="n">Unsupported</span> <span class="p">{</span> <span class="n">details</span><span class="p">:</span> <span class="o">&amp;</span><span class="err">'</span><span class="k">static</span> <span class="nb">str</span> <span class="p">},</span>
<span class="p">}</span>
</code></pre>
</div>
<p>Alle anderen Dinge braucht man zunächst einmal nicht (können aber später zur besseren Effizienz genutzt werden). Es ist somit jetzt einfach, die Kompatibilität zum früheren
Interface wieder herzustellen.</p>

<p>Die Allokator-API gilt für alle Allokatoren, Rust unterstützt Hierarchien von Allokatoren. Am Ende wird irgendwann die Speicherverwaltung des Betriebssystems von die
Standardbibliothek gerufen. Existiert kein solches (wie in unserem Fall) oder wird nur die Standardbibliothek nicht eingebunden, aber trotzdem Crates benutzt, die
Allozierungen vornehmen wollen, muss ein globaler Allokator angegeben werden. Dies wird einfach gemacht, indem einer Instanz einer Allokator-Struktur mit dem Attribut
<code class="highlighter-rouge">#[global_allocator]</code> dazu erklärt wird. Warum bei der Fehlermeldung oben dieses Attribut – das übrigens auch noch keinen Eintrag im
<a href="https://doc.rust-lang.org/unstable-book/">Unstable Book</a> hat – nicht genannt wurde, sondern <code class="highlighter-rouge">#[default_lib_allocator]</code> ist mir nicht ganz klar; vermutlich ist das bloß
noch nicht stabilisiert.</p>

<h3 id="guter-service">Guter Service</h3>
<p>Nachdem ich die <strong>kalloc</strong>-Bibliothek entfernt und einen Wrapper um die alten Allokator-Funktionen aus der <code class="highlighter-rouge">linked_list_allocator</code>-Bibliothek geschrieben hatte und der
neue Allokator tadellos lief, stellte ich fest, dass die von mir verwendete Version 0.2.7 der <code class="highlighter-rouge">linked_list_allocator</code>-Bibliothek gar nicht mehr die aktuelle ist. Die
derzeit neuste Version ist 0.4.1 und hat die neue Allokator-API schon vollständig umgesetzt. Danke an den Autor Philipp Oppermann, von dem auch das Blog
„<a href="https://os.phil-opp.com">Writing an OS in Rust</a>“ stammt.</p>

<p>Ich habe dann auf die neue Version umgestellt. Damit ist der Heap trivial, die Datei <strong>heap.rs</strong> sieht jetzt so aus:</p>

<figure class="highlight"><pre><code class="language-rust" data-lang="rust"><span class="c">///! Z.z. binden wir die einfach die neue Version von linked_list_allocator ein.</span>
<span class="c">///! Später soll die Interaktion mit dem Pager hinzukommen.</span>
<span class="k">extern</span> <span class="n">crate</span> <span class="n">linked_list_allocator</span><span class="p">;</span>
<span class="k">pub</span> <span class="k">use</span> <span class="k">self</span><span class="p">::</span><span class="nn">linked_list_allocator</span><span class="p">::</span><span class="n">LockedHeap</span><span class="p">;</span></code></pre></figure>

<p>Ich lasse sie aber erstmal trotzdem stehen, da ich – wie <a href="/aihpos/aihpos-heap/">hier</a> diskutiert – später den Heap überarbeiten und die den
Out-of-Memory-Fehler abfangen will.</p>

<p>Der Allokator der <code class="highlighter-rouge">linked_list_allocator</code>-Bibliothek ist übrigens durch einen Spin-Lock (aus der <a href="https://crates.io/crates/spin">spin</a>-Bibliothek) geschützt. Das ist in
<img alt="aihPOS" style="height:.78em; vertical-align:baseline" src="/SysOp/assets/img/sophia.png"> zwar (bisher) nicht nötig, da der komplette Kern unter Kernausschluss gestellt wird, schadet aber nicht und kann bei einer späteren Portierung nützlich sein.<sup id="fnref:3"><a href="#fn:3" class="footnote">3</a></sup></p>

<p>In <strong>main.rs</strong> wird der Allokator als <code class="highlighter-rouge">static</code> deklariert…</p>

<figure class="highlight"><pre><code class="language-rust" data-lang="rust"><span class="k">const</span> <span class="n">IRQ_STACK_SIZE</span><span class="p">:</span> <span class="nb">u32</span> <span class="o">=</span> <span class="mi">2048</span><span class="p">;</span>
<span class="k">pub</span>  <span class="k">const</span> <span class="n">INIT_HEAP_SIZE</span><span class="p">:</span> <span class="nb">usize</span> <span class="o">=</span> <span class="mi">25</span> <span class="o">*</span> <span class="mi">4096</span><span class="p">;</span> <span class="c">// 25 Seiten = 100 kB</span>

<span class="cp">#[global_allocator]</span>
<span class="k">static</span> <span class="n">HEAP</span><span class="p">:</span> <span class="n">LockedHeap</span> <span class="o">=</span> <span class="nn">LockedHeap</span><span class="p">::</span><span class="nf">empty</span><span class="p">();</span></code></pre></figure>

<p>… und wie folgt initialisiert:</p>

<figure class="highlight"><pre><code class="language-rust" data-lang="rust"><span class="k">fn</span> <span class="nf">init_heap</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">unsafe</span><span class="p">{</span>
        <span class="n">HEAP</span><span class="nf">.lock</span><span class="p">()</span><span class="nf">.init</span><span class="p">(</span><span class="n">__bss_start</span> <span class="k">as</span> <span class="nb">usize</span><span class="p">,</span> <span class="n">INIT_HEAP_SIZE</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>Jetzt funktioniert die Übersetzung wieder fehlerfrei.</p>

<p><a class="left button tiny radius" href="http://localhost:4000/aihpos/aihpos-vm/"><span class="icon-chevron-left"></span>Vorheriger Beitrag in AIHPOS</a></p>

<div class="row"></div>

<div class="footnotes">
  <ol>
    <li id="fn:1">
      <p> 18. Juli 2017&nbsp;<a href="#fnref:1" class="reversefootnote">&#8617;</a></p>
    </li>
    <li id="fn:2">
      <p>Ich bin mir nicht sicher, was die beste Bezeichnung im Deutschen für <code class="highlighter-rouge">enum</code> ist. Als C-Programmierer denkt man da an „Aufzählungstyp“, was aber in Rust in die Irre
    führt. „Summentyp“ ist typentheoretisch korrekt, klingt aber in meinen Ohren trotzdem eigenartig.&nbsp;<a href="#fnref:2" class="reversefootnote">&#8617;</a></p>
    </li>
    <li id="fn:3">
      <p>Natürlich ist es ein leichter Performance-Verlust, aber Performance ist ja ausdrücklich <em>kein</em> <a href="/aihpos/aihpos-1/">Design-Ziel</a> in <img alt="aihPOS" style="height:.78em; vertical-align:baseline" src="/SysOp/assets/img/sophia.png">.&nbsp;<a href="#fnref:3" class="reversefootnote">&#8617;</a></p>
    </li>
  </ol>
</div>

	                </span>
			

	                
		</article>
	</div><!-- /.medium-12.columns -->
</div><!-- /.row -->




	
	    <div id="up-to-top" class="row">
      <div class="small-12 columns" style="text-align: right;">
        <a class="iconfont" href="#top-of-page">&#xf108;</a>
      </div><!-- /.small-12.columns -->
    </div><!-- /.row -->


    <footer id="footer-content" class="bg-grau">
      <div id="footer">
        <div class="row">
          <div class="medium-6 large-5 columns">
            <h5 class="shadow-black">Über diese Website</h5>

            <p class="shadow-black">
              Matthias Werners Blog. 
              <a href="http://localhost:4000/info/">Mehr ›</a>
            </p>
          </div><!-- /.large-6.columns -->


          <div class="small-6 medium-3 large-3 large-offset-1 columns">
            
              
              <ul class="no-bullet shadow-black">
              
              </ul>
          </div><!-- /.large-4.columns -->


          <div class="small-6 medium-3 large-3 columns">
            
              
            <ul class="no-bullet shadow-black">
            
            </ul>
          </div><!-- /.large-3.columns -->
        </div><!-- /.row -->

      </div><!-- /#footer -->

    </footer>

	

	


<script src="http://localhost:4000/assets/js/javascript.min.js"></script>














</body>
</html>

