<!doctype html>
<html class="no-js" lang="de">
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>Please Mr. Postman</title>
	<link rel="stylesheet" type="text/css" href="http://sysop.matthias-werner.net/assets/css/styles_feeling_responsive.css" />
	<script src="http://sysop.matthias-werner.net/assets/js/modernizr.min.js"></script>

  <script src="https://ajax.googleapis.com/ajax/libs/webfont/1.5.18/webfont.js"></script>
  <script>
    WebFont.load({
      google: {
        families: [ 'Lato:400,700,400italic:latin', 'Volkhov::latin' ]
      }
    });
  </script>

  <noscript>
    <link href='http://fonts.googleapis.com/css?family=Lato:400,700,400italic|Volkhov' rel='stylesheet' type='text/css' />
  </noscript>

  
	
	<meta name="description" content="Bevor wir uns dem Design des Kernels widmen, wollen wir Informationen über das System einsammeln:  welchen Raspberry-Typ haben wir, wieviel Speicher steht zur Verfügung, etc.. Außerdem nutzen wir die Gelegenheit, das Debugging nochmal zu verbessern."/>

	

	



	
	<link rel="icon" sizes="32x32" href="http://sysop.matthias-werner.net/assets/img/favicon-32x32.png" />




	
	<link rel="icon" sizes="192x192" href="http://sysop.matthias-werner.net/assets/img/touch-icon-192x192.png" />




	
	<link rel="apple-touch-icon-precomposed" sizes="180x180" href="http://sysop.matthias-werner.net/assets/img/apple-touch-icon-180x180-precomposed.png" />




	
	<link rel="apple-touch-icon-precomposed" sizes="152x152" href="http://sysop.matthias-werner.net/assets/img/apple-touch-icon-152x152-precomposed.png" />




	
	<link rel="apple-touch-icon-precomposed" sizes="144x144" href="http://sysop.matthias-werner.net/assets/img/apple-touch-icon-144x144-precomposed.png" />




	
	<link rel="apple-touch-icon-precomposed" sizes="120x120" href="http://sysop.matthias-werner.net/assets/img/apple-touch-icon-120x120-precomposed.png" />




	
	<link rel="apple-touch-icon-precomposed" sizes="114x114" href="http://sysop.matthias-werner.net/assets/img/apple-touch-icon-114x114-precomposed.png" />




	
	<link rel="apple-touch-icon-precomposed" sizes="76x76" href="http://sysop.matthias-werner.net/assets/img/apple-touch-icon-76x76-precomposed.png" />




	
	<link rel="apple-touch-icon-precomposed" sizes="72x72" href="http://sysop.matthias-werner.net/assets/img/apple-touch-icon-72x72-precomposed.png" />




	
	<link rel="apple-touch-icon-precomposed" href="http://sysop.matthias-werner.net/assets/img/apple-touch-icon-precomposed.png" />	




	
	<meta name="msapplication-TileImage" content="http://sysop.matthias-werner.net/assets/img/msapplication_tileimage.png" />




	
	<meta name="msapplication-TileColor" content="#fabb00" />



	<!-- Facebook Optimization -->
	<meta property="og:locale" content="en_EN" />
	
	<meta property="og:title" content="Please Mr. Postman" />
	<meta property="og:description" content="Bevor wir uns dem Design des Kernels widmen, wollen wir Informationen über das System einsammeln:  welchen Raspberry-Typ haben wir, wieviel Speicher steht zur Verfügung, etc.. Außerdem nutzen wir die Gelegenheit, das Debugging nochmal zu verbessern." />
	<meta property="og:url" content="http://sysop.matthias-werner.net//aihpos/2017/04/26/aihpos-postman/" />
	<meta property="og:site_name" content="Systems Operational" />
	

	

	<!-- Search Engine Optimization -->
	

	<link type="text/plain" rel="author" href="http://sysop.matthias-werner.net/humans.txt" />

	

	
</head>
   <script type="text/javascript"
      src="https://cdn.rawgit.com/mathjax/MathJax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
   </script>
</head>
<body id="top-of-page" class="page-fullwidth">
	
	
<div id="navigation" class="sticky">
  <nav class="top-bar" role="navigation" data-topbar>
    <ul class="title-area">
      <li class="name">
      <h1 class="show-for-small-only"><a href="http://sysop.matthias-werner.net" class="icon-tree"> Systems Operational</a></h1>
    </li>
       <!-- Remove the class "menu-icon" to get rid of menu icon. Take out "Menu" to just have icon alone -->
      <li class="toggle-topbar menu-icon"><a href="#"><span>Navigation</span></a></li>
    </ul>
    <section class="top-bar-section">

      <ul class="right">
        

              

          
          
        

              

          
          
        

              

          
          
        

              

          
          
            
            
              <li class="divider"></li>
              <li><a href="http://sysop.matthias-werner.net/about/">Über mich</a></li>

            
            
          
        
        
      </ul>

      <ul class="left">
        

              

          
          

            
            
              <li><a href="http://sysop.matthias-werner.net/">Start</a></li>
              <li class="divider"></li>

            
            
          
        

              

          
          

            
            

              <li class="has-dropdown">
                <a href="http://sysop.matthias-werner.net/blog/">Blog</a>

                  <ul class="dropdown">
                    

                      

                      <li><a href="http://sysop.matthias-werner.net/blog/archive/">Archive</a></li>
                    
                  </ul>
                  
              </li>
              <li class="divider"></li>
            
          
        

              

          
          

            
            
              <li><a href="http://sysop.matthias-werner.net/blog/aihpos/">aihPos</a></li>
              <li class="divider"></li>

            
            
          
        

              

          
          
        
        
      </ul>
    </section>
  </nav>
</div><!-- /#navigation -->

	

	

<div id="masthead-no-image-header">
	<div class="row">
		<div class="small-12 columns">
			<a id="logo" href="http://sysop.matthias-werner.net" title="Systems Operational – Matthias Werners selten gepflegtes Blog über Computer und Menschen">
				<img src="http://sysop.matthias-werner.net/assets/img/logo.png" alt="Systems Operational – Matthias Werners selten gepflegtes Blog über Computer und Menschen">
			</a>
		</div><!-- /.small-12.columns -->
	</div><!-- /.row -->
</div><!-- /#masthead -->









	


<div class="row t30">
	<div class="medium-12 columns">
		<article>
			<header>
				<p class="subheadline">Ein Betriebsystem für die Lehre</p>
				<h1>Please Mr. Postman</h1>
			</header>

			

			<span itemprop="articleSection">
	                <p><strong>Inhalt</strong></p>
<ul id="markdown-toc">
  <li><a href="#mailboxen" id="markdown-toc-mailboxen">Mailboxen</a></li>
  <li><a href="#property-tags" id="markdown-toc-property-tags">Property Tags</a>    <ul>
      <li><a href="#alignment" id="markdown-toc-alignment">Alignment</a></li>
      <li><a href="#tag-puffer" id="markdown-toc-tag-puffer">Tag-Puffer</a></li>
      <li><a href="#zuwenig-speicher" id="markdown-toc-zuwenig-speicher">Zuwenig Speicher?</a></li>
    </ul>
  </li>
  <li><a href="#kprint" id="markdown-toc-kprint">Kprint</a>    <ul>
      <li><a href="#vom-pixel-zum-string" id="markdown-toc-vom-pixel-zum-string">Vom Pixel zum String</a></li>
      <li><a href="#scrollen" id="markdown-toc-scrollen">Scrollen</a></li>
      <li><a href="#no-race-codition" id="markdown-toc-no-race-codition">(No) Race Codition</a></li>
    </ul>
  </li>
  <li><a href="#der-linker-zickt-mal-wieder" id="markdown-toc-der-linker-zickt-mal-wieder">Der Linker zickt mal wieder</a></li>
</ul>

<p><a class="left button tiny radius" href="http://sysop.matthias-werner.net/aihpos/2017/04/10/aihpos-lebenszeichen/"><span class="icon-chevron-left"></span>Vorheriger Beitrag in AIHPOS</a></p>

<p><a class="right button tiny radius r15" href="http://sysop.matthias-werner.net/aihpos/2017/05/14/aihpos-umrustung/">Nächster Beitrag in AIHPOS<span class="icon-chevron-right"></span></a></p>

<div class="row"></div>

<p>Bevor wir uns dem Design des Kernels widmen, wollen wir Informationen über das System einsammeln. Auch wenn mein Testboard ein Raspberry Pi 1B+ ist, sollte ein
Betriebssystem dafür doch mindestens so portabel sein, dass es auf verschiedenen Raspberries laufen kann. Dazu wäre es z.B. wichtig zu erfahren, welchen Raspberry-Typ wir
haben, wieviel Speicher zur Verfügung steht und wo die I/O-Hardware liegt.</p>

<h2 id="mailboxen">Mailboxen</h2>

<p>Glücklicherweise kümmert sich um das alles die GPU. Diese hat auch eine Schnittstelle, über die es mit dem ARM reden kann, das sogenannte <a href="https://github.com/raspberrypi/firmware/wiki/Mailboxes">Mailbox-System</a>. Mailboxes
sind FIFO-Speicher mit einer Breite von 28 Bit. Jede Mailbox ist in Kanäle unterteilt, die für unterschiedliche Arten von Informationen vorgesehen ist. Es kann pro
Mailbox maximal 16 Kanäle geben. Daten und Kanalinformationen werden mit einem Datenwort übergeben, wobei die Kanalnummer die untersten vier Bit einnimmt und das zu
übertragende Datum die oberen 28. Auch wenn die „größeren“ Raspberries eine ganze Menge von Mailboxen haben, interessiert uns im Moment nur die Mailbox 0
(bzw. Mailbox 1 für die Rückantwort). Mailbox 0 hat 9 Kanäle. Für die Datenübertragung muss jeweils auf den passenden Status gewartet werden. Wir machen das im
Moment mit einem Busy Wait. Allerdings kann man auch wesentlich eleganter vorgehen und einen Interrupt auslösen lassen, wenn Daten bereit stehen.</p>

<figure class="highlight"><pre><code class="language-rust" data-lang="rust"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
</pre></td><td class="code"><pre><span class="k">use</span> <span class="nn">core</span><span class="p">::</span><span class="nn">intrinsics</span><span class="p">::{</span><span class="n">volatile_load</span><span class="p">,</span><span class="n">volatile_store</span><span class="p">};</span>
<span class="k">use</span> <span class="nn">core</span><span class="p">::</span><span class="nn">mem</span><span class="p">::</span><span class="n">transmute</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">hal</span><span class="p">::</span><span class="nn">cpu</span><span class="p">::</span><span class="n">Cpu</span><span class="p">;</span>

<span class="c">// Basisadresse des Mailregisters</span>
<span class="k">const</span> <span class="n">MAILBOX_BASE</span><span class="p">:</span> <span class="nb">u32</span> <span class="o">=</span> <span class="mi">0x2000B880</span><span class="p">;</span>

<span class="c">/// Kanäle des Mailbox-Interfaces</span>
<span class="nd">#[allow(dead_code)]</span>
<span class="nd">#[derive(Clone,Copy)]</span>
<span class="nd">#[repr(u32)]</span>
<span class="nd">#[allow(missing_docs)]</span>
<span class="k">pub</span> <span class="k">enum</span> <span class="n">Channel</span> <span class="p">{</span>
    <span class="n">PowerManagement</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">Framebuffer</span><span class="p">,</span>
    <span class="n">VirtualUart</span><span class="p">,</span>
    <span class="n">Vchiq</span><span class="p">,</span>
    <span class="n">Leds</span><span class="p">,</span>
    <span class="n">Buttons</span><span class="p">,</span>
    <span class="n">Touchscreen</span><span class="p">,</span>
    <span class="n">Unused</span><span class="p">,</span>
    <span class="n">ATags</span><span class="p">,</span>
    <span class="n">IATags</span>
<span class="p">}</span>

<span class="k">const</span> <span class="n">MAILBOX_FULL</span><span class="p">:</span>  <span class="nb">u32</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">31</span><span class="p">;</span>
<span class="k">const</span> <span class="n">MAILBOX_EMPTY</span><span class="p">:</span> <span class="nb">u32</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">30</span><span class="p">;</span>

<span class="nd">#[allow(dead_code)]</span>
<span class="nd">#[repr(C)]</span>
<span class="k">pub</span> <span class="k">struct</span> <span class="n">Mailbox</span> <span class="p">{</span>
    <span class="n">read</span><span class="p">:</span>    <span class="nb">u32</span><span class="p">,</span>      <span class="c">// 0x00</span>
    <span class="n">_unused</span><span class="p">:</span> <span class="p">[</span><span class="nb">u32</span><span class="p">;</span> <span class="mi">3</span><span class="p">],</span>     <span class="c">// 0x04 0x08 0x0C</span>
    <span class="n">poll</span><span class="p">:</span>    <span class="nb">u32</span><span class="p">,</span>      <span class="c">// 0x10 </span>
    <span class="n">sender</span><span class="p">:</span>  <span class="nb">u32</span><span class="p">,</span>      <span class="c">// 0x14</span>
    <span class="n">status</span><span class="p">:</span>  <span class="nb">u32</span><span class="p">,</span>      <span class="c">// 0x18</span>
    <span class="n">configuration</span><span class="p">:</span> <span class="nb">u32</span><span class="p">,</span><span class="c">// 0x1C</span>
    <span class="n">write</span><span class="p">:</span>   <span class="nb">u32</span><span class="p">,</span>      <span class="c">// 0x20 Mailbox 1!</span>
<span class="p">}</span>

<span class="k">impl</span> <span class="n">Mailbox</span> <span class="p">{</span>
    <span class="c">/// Liest die Antwort aus Kanal `channel`</span>
    <span class="k">pub</span> <span class="k">fn</span> <span class="nf">read</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="k">self</span><span class="p">,</span> <span class="n">channel</span><span class="p">:</span> <span class="n">Channel</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="nb">u32</span> <span class="p">{</span>
        <span class="k">let</span> <span class="k">mut</span> <span class="n">ret</span> <span class="p">;</span>
        <span class="k">loop</span><span class="p">{</span>
            <span class="k">while</span> <span class="p">(</span><span class="k">unsafe</span><span class="p">{</span><span class="nn">volatile_load</span><span class="p">::</span><span class="o">&lt;</span><span class="nb">u32</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="py">.status</span> <span class="k">as</span> <span class="o">*</span><span class="k">const</span> <span class="n">_</span> <span class="p">)}</span> <span class="o">&amp;</span> <span class="n">MAILBOX_EMPTY</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
                <span class="c">// DMB: Das ist evtl. redundant zum "volatile", aber empfohlen im Firmware-Wiki:</span>
                <span class="c">// mindestens nach dem letzten Lesen und vor dem ersten Schreiben</span>
                <span class="c">// (vgl. https://github.com/raspberrypi/firmware/wiki/</span>
                <span class="c">//  Accessing-mailboxes#memory-barriers--invalidatingflushing-data-cache)</span>
                <span class="nn">Cpu</span><span class="p">::</span><span class="nf">data_memory_barrier</span><span class="p">();</span>
            <span class="p">}</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="k">unsafe</span><span class="p">{</span><span class="nn">volatile_load</span><span class="p">::</span><span class="o">&lt;</span><span class="nb">u32</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="py">.read</span> <span class="k">as</span> <span class="o">*</span><span class="k">const</span> <span class="n">_</span><span class="p">)};</span>
            <span class="nn">Cpu</span><span class="p">::</span><span class="nf">data_memory_barrier</span><span class="p">();</span>
            <span class="k">if</span> <span class="n">ret</span> <span class="o">&amp;</span> <span class="mi">0xF</span> <span class="o">==</span> <span class="n">channel</span> <span class="k">as</span> <span class="nb">u32</span> <span class="p">{</span>
                <span class="k">return</span> <span class="n">ret</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c">/// Schreibt in den Kanal `channel` die Daten, die an der Adresse `addr` zu finden sind.</span>
    <span class="k">pub</span> <span class="k">fn</span> <span class="nf">write</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="k">self</span><span class="p">,</span> <span class="n">channel</span><span class="p">:</span> <span class="n">Channel</span><span class="p">,</span> <span class="n">addr</span><span class="p">:</span> <span class="nb">u32</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">assert</span><span class="o">!</span><span class="p">(</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="mi">0x0Fu32</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
        <span class="k">while</span> <span class="k">unsafe</span><span class="p">{</span><span class="nf">volatile_load</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="k">self</span><span class="py">.status</span><span class="p">)}</span> <span class="o">&amp;</span> <span class="n">MAILBOX_FULL</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
            <span class="nn">Cpu</span><span class="p">::</span><span class="nf">data_memory_barrier</span><span class="p">();</span>
        <span class="p">};</span>
        <span class="nn">Cpu</span><span class="p">::</span><span class="nf">data_memory_barrier</span><span class="p">();</span>
        <span class="k">unsafe</span><span class="p">{</span> <span class="nn">volatile_store</span><span class="p">::</span><span class="o">&lt;</span><span class="nb">u32</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="k">self</span><span class="py">.write</span> <span class="k">as</span> <span class="o">*</span><span class="k">mut</span> <span class="n">_</span><span class="p">,</span> <span class="n">addr</span> <span class="p">|</span> <span class="n">channel</span> <span class="k">as</span> <span class="nb">u32</span><span class="p">)};</span> 
    <span class="p">}</span>

<span class="p">}</span>

<span class="c">/// Gibt die Mailbox `nr`</span>
<span class="c">///</span>
<span class="c">/// # Anmerkung</span>
<span class="c">/// Es ist nur Mailbox 0 implementiert, alle anderen Nummern erzeugen eine Panik.</span>
<span class="k">pub</span> <span class="k">fn</span> <span class="nf">mailbox</span><span class="p">(</span><span class="n">nr</span><span class="p">:</span> <span class="nb">u8</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="o">&amp;</span><span class="nv">'static</span> <span class="k">mut</span> <span class="n">Mailbox</span> <span class="p">{</span>
    <span class="k">match</span> <span class="n">nr</span><span class="p">{</span>
        <span class="mi">0</span> <span class="k">=&gt;</span> <span class="k">unsafe</span><span class="p">{</span> <span class="nf">transmute</span><span class="p">(</span><span class="n">MAILBOX_BASE</span><span class="p">)},</span>
        <span class="n">_</span> <span class="k">=&gt;</span> <span class="nd">panic!</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span></pre></td></tr></tbody></table></code></pre></figure>

<h2 id="property-tags">Property Tags</h2>

<p>Der für uns interessante ist Kanal 8. Über ihn werden Eigenschaften abgefragt und gesetzt, jeweils über einen <em>property tag</em>. Einige dieser Tags werden auch als <a href="http://www.simtec.co.uk/products/SWLINUX/files/booting_article.html#appendix_tag_reference">ATAG</a>
dem Kernel beim Start zur Verfügung gestellt, aber der Kanal 8 bietet mehr. Diese Property Tag werden – sowohl bei der Abfrage als auch bei der Antwort – über eine verkettete Liste übertragen, die folgende Struktur hat:</p>

<p><img src="http://sysop.matthias-werner.net/images/tag-list.png" alt="" class="img-responsive" /></p>

<p>Die Tag-ID bestimmt, welche Art von Information übertragen wird. Und auch wenn im Moment noch nicht alle Informationen wichtig sind, definieren wir schon mal alle Tags „auf Vorrat“in einem enum:</p>

<figure class="highlight"><pre><code class="language-rust" data-lang="rust"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
</pre></td><td class="code"><pre><span class="err">#</span><span class="p">[</span><span class="nf">derive</span><span class="p">(</span><span class="n">Clone</span><span class="p">,</span><span class="nb">Copy</span><span class="p">)]</span>
<span class="nd">#[repr(u32)]</span>
<span class="nd">#[allow(missing_docs)]</span>
<span class="c">/// Tags des Mailbox-Interface. Für die Bedeutungen der einzelnen Tags</span>
<span class="c">/// siehe [Raspberry Firmware</span>
<span class="c">/// Wiki](https://github.com/raspberrypi/firmware/wiki/Mailbox-property-interface)</span>
<span class="k">pub</span> <span class="k">enum</span> <span class="n">Tag</span> <span class="p">{</span>
    <span class="nb">None</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="c">// Firmware</span>
    <span class="n">GetFirmwareVersion</span> <span class="o">=</span> <span class="mi">0x1</span><span class="p">,</span>

    <span class="c">// Board</span>
    <span class="n">GetBoardModel</span> <span class="o">=</span> <span class="mi">0x10001</span><span class="p">,</span>
    <span class="n">GetBoardRevision</span><span class="p">,</span>
    <span class="n">GetBoardMacAddress</span><span class="p">,</span>
    <span class="n">GetBoardSerial</span><span class="p">,</span>
    <span class="n">GetArmMemory</span><span class="p">,</span>
    <span class="n">GetVcMemory</span><span class="p">,</span>
    <span class="n">GetClocks</span><span class="p">,</span>

    <span class="c">// Befehlszeile</span>
    <span class="n">GetCommandLine</span> <span class="o">=</span> <span class="mi">0x50001</span><span class="p">,</span>

    <span class="c">// DMA</span>
    <span class="n">GetDmaChannels</span> <span class="o">=</span> <span class="mi">0x60001</span><span class="p">,</span>

    <span class="c">// Powermanagement</span>
    <span class="n">GetPowerState</span> <span class="o">=</span> <span class="mi">0x20001</span><span class="p">,</span>
    <span class="n">GetTiming</span> <span class="o">=</span> <span class="mi">0x20002</span><span class="p">,</span>
    <span class="n">SetPowerState</span> <span class="o">=</span> <span class="mi">0x28001</span><span class="p">,</span>

    <span class="c">// Uhren</span>
    <span class="n">GetClockState</span> <span class="o">=</span> <span class="mi">0x30001</span><span class="p">,</span>
    <span class="n">SetClockState</span> <span class="o">=</span> <span class="mi">0x38001</span><span class="p">,</span>
    <span class="n">GetClockRate</span> <span class="o">=</span> <span class="mi">0x30002</span><span class="p">,</span>
    <span class="n">SetClockRate</span> <span class="o">=</span> <span class="mi">0x38002</span><span class="p">,</span>
    <span class="n">GetMaxClockRate</span> <span class="o">=</span> <span class="mi">0x30004</span><span class="p">,</span>
    <span class="n">GetMinClockRate</span> <span class="o">=</span> <span class="mi">0x30007</span><span class="p">,</span>
    <span class="n">GetTurbo</span> <span class="o">=</span> <span class="mi">0x30009</span><span class="p">,</span>
    <span class="n">SetTurbo</span> <span class="o">=</span> <span class="mi">0x38009</span><span class="p">,</span>

    <span class="c">// Spannungsregelung</span>
    <span class="n">GetVoltage</span> <span class="o">=</span> <span class="mi">0x30003</span><span class="p">,</span>
    <span class="n">SetVoltage</span> <span class="o">=</span> <span class="mi">0x38003</span><span class="p">,</span>
    <span class="n">GetMaxVoltage</span> <span class="o">=</span> <span class="mi">0x30005</span><span class="p">,</span>
    <span class="n">GetMinVoltage</span> <span class="o">=</span> <span class="mi">0x30008</span><span class="p">,</span>
    <span class="n">GetTemperature</span> <span class="o">=</span> <span class="mi">0x30006</span><span class="p">,</span>
    <span class="n">GetMaxTemperature</span> <span class="o">=</span> <span class="mi">0x3000A</span><span class="p">,</span>
    <span class="n">AllocateMemory</span> <span class="o">=</span> <span class="mi">0x3000C</span><span class="p">,</span>
    <span class="n">LockMemory</span> <span class="o">=</span> <span class="mi">0x3000D</span><span class="p">,</span>
    <span class="n">UnlockMemory</span> <span class="o">=</span> <span class="mi">0x3000E</span><span class="p">,</span>
    <span class="n">ReleaseMemory</span> <span class="o">=</span> <span class="mi">0x3000F</span><span class="p">,</span>
    <span class="n">ExecuteCode</span> <span class="o">=</span> <span class="mi">0x30010</span><span class="p">,</span>
    <span class="n">GetDispmanxResHandle</span> <span class="o">=</span> <span class="mi">0x30014</span><span class="p">,</span>
    <span class="n">GetEDIDBlock</span> <span class="o">=</span> <span class="mi">0x30020</span><span class="p">,</span>

    <span class="c">// Framebuffer</span>
    <span class="n">AllocateFrameBuffer</span> <span class="o">=</span> <span class="mi">0x40001</span><span class="p">,</span>
    <span class="n">ReleaseFrameBuffer</span> <span class="o">=</span> <span class="mi">0x48001</span><span class="p">,</span>
    <span class="n">BlankScreen</span> <span class="o">=</span> <span class="mi">0x40002</span><span class="p">,</span>
    <span class="n">GetPhysicalDisplaySize</span> <span class="o">=</span> <span class="mi">0x40003</span><span class="p">,</span>
    <span class="n">TestPhysicalDisplaySize</span> <span class="o">=</span> <span class="mi">0x44003</span><span class="p">,</span>
    <span class="n">SetPhysicalDisplaySize</span> <span class="o">=</span> <span class="mi">0x48003</span><span class="p">,</span>
    <span class="n">GetVirtualDisplaySize</span> <span class="o">=</span> <span class="mi">0x40004</span><span class="p">,</span>
    <span class="n">TestVirtualDisplaySize</span> <span class="o">=</span> <span class="mi">0x44004</span><span class="p">,</span>
    <span class="n">SetVirtualDisplaySize</span> <span class="o">=</span> <span class="mi">0x48004</span><span class="p">,</span>
    <span class="n">GetDepth</span> <span class="o">=</span> <span class="mi">0x40005</span><span class="p">,</span>
    <span class="n">TestDepth</span> <span class="o">=</span> <span class="mi">0x44005</span><span class="p">,</span>
    <span class="n">SetDepth</span> <span class="o">=</span> <span class="mi">0x48005</span><span class="p">,</span>
    <span class="n">GetPixelOrder</span> <span class="o">=</span> <span class="mi">0x40006</span><span class="p">,</span>
    <span class="n">TestPixelOrder</span> <span class="o">=</span> <span class="mi">0x44006</span><span class="p">,</span>
    <span class="n">SetPixelOrder</span> <span class="o">=</span> <span class="mi">0x48006</span><span class="p">,</span>
    <span class="n">GetAlphaMode</span> <span class="o">=</span> <span class="mi">0x40007</span><span class="p">,</span>
    <span class="n">TestAlphaMode</span> <span class="o">=</span> <span class="mi">0x44007</span><span class="p">,</span>
    <span class="n">SetAlphaMode</span> <span class="o">=</span> <span class="mi">0x48007</span><span class="p">,</span>
    <span class="n">GetPitch</span> <span class="o">=</span> <span class="mi">0x40008</span><span class="p">,</span>
    <span class="n">GetVirtualOffset</span> <span class="o">=</span> <span class="mi">0x40009</span><span class="p">,</span>
    <span class="n">TestVirtualOffset</span> <span class="o">=</span> <span class="mi">0x44009</span><span class="p">,</span>
    <span class="n">SetVirtualOffset</span> <span class="o">=</span> <span class="mi">0x48009</span><span class="p">,</span>
    <span class="n">GetOverscan</span> <span class="o">=</span> <span class="mi">0x4000A</span><span class="p">,</span>
    <span class="n">TestOverscan</span> <span class="o">=</span> <span class="mi">0x4400A</span><span class="p">,</span>
    <span class="n">SetOverscan</span> <span class="o">=</span> <span class="mi">0x4800A</span><span class="p">,</span>
    <span class="n">GetPalette</span> <span class="o">=</span> <span class="mi">0x4000B</span><span class="p">,</span>
    <span class="n">TestPalette</span> <span class="o">=</span> <span class="mi">0x4400B</span><span class="p">,</span>
    <span class="n">SetPalette</span> <span class="o">=</span> <span class="mi">0x4800B</span><span class="p">,</span></pre></td></tr></tbody></table></code></pre></figure>

<p>Bei der Antwort auf einen Request wird der Frage-Puffer überschrieben. Es muss also dafür gesorgt werden, dass genügend Platz für die Antwort zur Verfügung steht. Je nach
<a href="https://github.com/raspberrypi/firmware/wiki/Mailbox-property-interface">Tag-Typ</a> ist das unterschiedlich:</p>

<figure class="highlight"><pre><code class="language-rust" data-lang="rust"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
</pre></td><td class="code"><pre>    <span class="n">SetCursorState</span> <span class="o">=</span> <span class="mi">0x8010</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">ReqProperty</span> <span class="p">{</span>
    <span class="k">pub</span> <span class="n">tag</span><span class="p">:</span>  <span class="n">Tag</span><span class="p">,</span>
    <span class="k">pub</span> <span class="n">buf_size</span><span class="p">:</span> <span class="nb">usize</span><span class="p">,</span>
    <span class="k">pub</span> <span class="n">param_size</span><span class="p">:</span> <span class="nb">usize</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">impl</span> <span class="n">ReqProperty</span> <span class="p">{</span>
    <span class="k">fn</span> <span class="nf">new</span><span class="p">(</span><span class="n">tag</span><span class="p">:</span> <span class="n">Tag</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="n">ReqProperty</span> <span class="p">{</span>
        <span class="k">let</span> <span class="p">(</span><span class="n">buf_size</span><span class="p">,</span> <span class="n">param_size</span><span class="p">)</span> <span class="o">=</span> <span class="c">// buf_size ist in Bytes, param_size in u32</span>
            <span class="k">match</span> <span class="n">tag</span> <span class="p">{</span>
                <span class="nn">Tag</span><span class="p">::</span><span class="n">GetFirmwareVersion</span><span class="p">|</span>
                <span class="nn">Tag</span><span class="p">::</span><span class="n">GetBoardModel</span> <span class="p">|</span>
                <span class="nn">Tag</span><span class="p">::</span><span class="n">GetBoardRevision</span> <span class="p">|</span>
                <span class="nn">Tag</span><span class="p">::</span><span class="n">GetBoardMacAddress</span> <span class="p">|</span>
                <span class="nn">Tag</span><span class="p">::</span><span class="n">GetBoardSerial</span> <span class="p">|</span>
                <span class="nn">Tag</span><span class="p">::</span><span class="n">GetArmMemory</span> <span class="p">|</span>
                <span class="nn">Tag</span><span class="p">::</span><span class="n">GetVcMemory</span> <span class="p">|</span>
                <span class="nn">Tag</span><span class="p">::</span><span class="n">GetDmaChannels</span> <span class="p">|</span>
                <span class="nn">Tag</span><span class="p">::</span><span class="n">GetPhysicalDisplaySize</span> <span class="p">|</span>
                <span class="nn">Tag</span><span class="p">::</span><span class="n">GetVirtualDisplaySize</span> <span class="p">|</span>
                <span class="nn">Tag</span><span class="p">::</span><span class="n">GetVirtualOffset</span>
                <span class="k">=&gt;</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span>
                <span class="nn">Tag</span><span class="p">::</span><span class="n">GetClocks</span> <span class="p">|</span>
                <span class="nn">Tag</span><span class="p">::</span><span class="n">GetCommandLine</span>
                <span class="k">=&gt;</span> <span class="p">(</span><span class="mi">256</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span>
                <span class="nn">Tag</span><span class="p">::</span><span class="n">GetPowerState</span> <span class="p">|</span>
                <span class="nn">Tag</span><span class="p">::</span><span class="n">GetTiming</span> <span class="p">|</span>
                <span class="nn">Tag</span><span class="p">::</span><span class="n">GetClockState</span> <span class="p">|</span>
                <span class="nn">Tag</span><span class="p">::</span><span class="n">GetClockRate</span> <span class="p">|</span>
                <span class="nn">Tag</span><span class="p">::</span><span class="n">GetMaxClockRate</span> <span class="p">|</span>
                <span class="nn">Tag</span><span class="p">::</span><span class="n">GetMinClockRate</span> <span class="p">|</span>
                <span class="nn">Tag</span><span class="p">::</span><span class="n">GetTurbo</span> <span class="p">|</span>
                <span class="nn">Tag</span><span class="p">::</span><span class="n">GetVoltage</span> <span class="p">|</span>
                <span class="nn">Tag</span><span class="p">::</span><span class="n">GetMaxVoltage</span> <span class="p">|</span>
                <span class="nn">Tag</span><span class="p">::</span><span class="n">GetMinVoltage</span> <span class="p">|</span>
                <span class="nn">Tag</span><span class="p">::</span><span class="n">GetTemperature</span> <span class="p">|</span>
                <span class="nn">Tag</span><span class="p">::</span><span class="n">GetMaxTemperature</span> <span class="p">|</span>
                <span class="nn">Tag</span><span class="p">::</span><span class="n">GetDispmanxResHandle</span> <span class="p">|</span>
                <span class="nn">Tag</span><span class="p">::</span><span class="n">AllocateFrameBuffer</span>
                <span class="k">=&gt;</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span>
                <span class="nn">Tag</span><span class="p">::</span><span class="n">TestPhysicalDisplaySize</span> <span class="p">|</span>
                <span class="nn">Tag</span><span class="p">::</span><span class="n">SetPhysicalDisplaySize</span> <span class="p">|</span>
                <span class="nn">Tag</span><span class="p">::</span><span class="n">TestVirtualDisplaySize</span> <span class="p">|</span>
                <span class="nn">Tag</span><span class="p">::</span><span class="n">SetVirtualDisplaySize</span> <span class="p">|</span>
                <span class="nn">Tag</span><span class="p">::</span><span class="n">TestVirtualOffset</span> <span class="p">|</span>
                <span class="nn">Tag</span><span class="p">::</span><span class="n">SetVirtualOffset</span> <span class="p">|</span>
                <span class="nn">Tag</span><span class="p">::</span><span class="n">SetPowerState</span> <span class="p">|</span>
                <span class="nn">Tag</span><span class="p">::</span><span class="n">SetClockState</span> <span class="p">|</span>
                <span class="nn">Tag</span><span class="p">::</span><span class="n">SetTurbo</span> <span class="p">|</span>
                <span class="nn">Tag</span><span class="p">::</span><span class="n">SetVoltage</span>
                <span class="k">=&gt;</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span>
                <span class="nn">Tag</span><span class="p">::</span><span class="n">SetAlphaMode</span> <span class="p">|</span>
                <span class="nn">Tag</span><span class="p">::</span><span class="n">SetPixelOrder</span> <span class="p">|</span>
                <span class="nn">Tag</span><span class="p">::</span><span class="n">SetDepth</span> <span class="p">|</span>
                <span class="nn">Tag</span><span class="p">::</span><span class="n">LockMemory</span> <span class="p">|</span>
                <span class="nn">Tag</span><span class="p">::</span><span class="n">ReleaseMemory</span> <span class="p">|</span>
                <span class="nn">Tag</span><span class="p">::</span><span class="n">UnlockMemory</span> <span class="p">|</span>
                <span class="nn">Tag</span><span class="p">::</span><span class="n">BlankScreen</span> <span class="p">|</span>
                <span class="nn">Tag</span><span class="p">::</span><span class="n">TestDepth</span> <span class="p">|</span>
                <span class="nn">Tag</span><span class="p">::</span><span class="n">TestPixelOrder</span> <span class="p">|</span>
                <span class="nn">Tag</span><span class="p">::</span><span class="n">TestAlphaMode</span>
                <span class="k">=&gt;</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span>
                <span class="nn">Tag</span><span class="p">::</span><span class="n">GetAlphaMode</span> <span class="p">|</span>
                <span class="nn">Tag</span><span class="p">::</span><span class="n">GetPixelOrder</span> <span class="p">|</span>
                <span class="nn">Tag</span><span class="p">::</span><span class="n">GetPitch</span> <span class="p">|</span>
                <span class="nn">Tag</span><span class="p">::</span><span class="n">GetDepth</span>
                <span class="k">=&gt;</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span>
                <span class="nn">Tag</span><span class="p">::</span><span class="n">GetOverscan</span>  
                <span class="k">=&gt;</span> <span class="p">(</span><span class="mi">16</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span>
                <span class="nn">Tag</span><span class="p">::</span><span class="n">SetOverscan</span> <span class="p">|</span>
                <span class="nn">Tag</span><span class="p">::</span><span class="n">TestOverscan</span>
                <span class="k">=&gt;</span> <span class="p">(</span><span class="mi">16</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span>
                <span class="nn">Tag</span><span class="p">::</span><span class="n">SetClockRate</span>
                <span class="k">=&gt;</span> <span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span>  <span class="c">// Antwortgröße: 8</span>
                <span class="nn">Tag</span><span class="p">::</span><span class="n">AllocateMemory</span>
                <span class="k">=&gt;</span> <span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span>  <span class="c">// Antwortgröße: 4</span>
                <span class="nn">Tag</span><span class="p">::</span><span class="n">ExecuteCode</span>
                <span class="k">=&gt;</span> <span class="p">(</span><span class="mi">28</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span>
                <span class="nn">Tag</span><span class="p">::</span><span class="n">GetEDIDBlock</span>
                <span class="k">=&gt;</span> <span class="p">(</span><span class="mi">136</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span>
                <span class="nn">Tag</span><span class="p">::</span><span class="n">ReleaseFrameBuffer</span>
                <span class="k">=&gt;</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span>
                <span class="nn">Tag</span><span class="p">::</span><span class="n">GetPalette</span>
                <span class="k">=&gt;</span> <span class="p">(</span><span class="mi">1024</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span>
                <span class="nn">Tag</span><span class="p">::</span><span class="n">TestPalette</span> <span class="p">|</span>
                <span class="nn">Tag</span><span class="p">::</span><span class="n">SetPalette</span>
                <span class="k">=&gt;</span> <span class="p">(</span><span class="mi">1032</span><span class="p">,</span><span class="mi">258</span><span class="p">),</span>  <span class="c">// maximale Größe</span>
                <span class="nn">Tag</span><span class="p">::</span><span class="n">SetCursorInfo</span>
                <span class="k">=&gt;</span> <span class="p">(</span><span class="mi">24</span><span class="p">,</span><span class="mi">6</span><span class="p">),</span>
                <span class="nn">Tag</span><span class="p">::</span><span class="n">SetCursorState</span>
                <span class="k">=&gt;</span> <span class="p">(</span><span class="mi">16</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span>
                <span class="nn">Tag</span><span class="p">::</span><span class="nb">None</span> <span class="k">=&gt;</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
        <span class="p">};</span></pre></td></tr></tbody></table></code></pre></figure>

<p>Da für die über den Kanal ausgetauschte Information wenige Bytes mitunter nicht ausreichen, werden über die Mailbox Adressen eine Puffers kommuniziert, die die
eigentliche Information enthalten. Selbst eine solche Adresse kann mit 28 Bit nicht vollständig dargestellt werden: Es werden nur die obersten 28 Bit der Adresse werden
übertragen, der Rest als 0 angenommen. Damit muss ein solcher Puffer ein entsprechendes Alignment haben, d.h., seine Adresse muss mit 0000 enden.</p>

<h3 id="alignment">Alignment</h3>

<p>In Standard-Rust ein bestimmtes Alignment zu erreichen, ist ohne externe Hilfe unmöglich.<sup id="fnref:1"><a href="#fn:1" class="footnote">1</a></sup> Natürlich können wir im Linkerfile einen statischen Speicherbereich mit entsprechenden Alignment anlegen und von Rust aus nutzen, aber das ist erstens unsicher und zweitens ist dieser Speicher dann für diesen Zweck reserviert. Schöner wäre es, wenn wir den Puffer dynamisch anlegen können, und – da wir noch keine Heap-Verwaltung haben – natürlich auf dem Stack.</p>

<p>Glücklicherweise bietet nightly Rust hier Möglichkeiten. Bis vor kurzem musste man tricksen und mit Hilfe von <code class="highlighter-rouge">#[repr(simd)]</code>  behaupten, dass eine Vektorverarbeitung
vorgenommen wird. Seit neuesten<sup id="fnref:2"><a href="#fn:2" class="footnote">2</a></sup> steht ein eigenes Alignment-Attribut zur Verfügung. Bei seiner Nutzung muss man beachten, dass die Syntax aus dem entsprechenden
<a href="https://github.com/rust-lang/rfcs/blob/master/text/1358-repr-align.md">RFC 1358</a> falsch ist, statt z.B. <code class="highlighter-rouge">#[repr(align="16")]</code> wird das Alignment als (ebenfalls relativ neues) „Attribut-Literal“angegeben:
<code class="highlighter-rouge">#[repr(align(16))]</code>. Es müssen also gleich zwei Featuregates freigeschaltet werden, <code class="highlighter-rouge">#![feature(repr_align)]</code> und <code class="highlighter-rouge">#![feature(attr_literals)]</code>.</p>

<h3 id="tag-puffer">Tag-Puffer</h3>

<p>Die Implementation des Tag-Puffers ist unkompliziert. Man muss lediglich darauf achten, dass die Daten <code class="highlighter-rouge">u32</code>-Wörter sind, aber die Größen stets in Byte gemessen
werden. Entsprechend ist ab und zu eine Multiplikation oder Division mit 4 notwendig, die durch die Shift-Operatoren <code class="highlighter-rouge">&lt;&lt;</code> realisiert werden.</p>

<figure class="highlight"><pre><code class="language-rust" data-lang="rust"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
</pre></td><td class="code"><pre>    <span class="p">}</span>
<span class="p">}</span>

<span class="nd">#[repr(u32)]</span>
<span class="k">enum</span> <span class="n">ReqResCode</span> <span class="p">{</span>
    <span class="n">Request</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="nb">Success</span> <span class="o">=</span> <span class="mi">0x80000000</span><span class="p">,</span>
    <span class="n">Error</span>   <span class="o">=</span> <span class="mi">0x80000001</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">enum</span> <span class="n">TagReqResp</span> <span class="p">{</span>
    <span class="n">Request</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">Response</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">31</span>
<span class="p">}</span>

<span class="k">enum</span> <span class="n">PbOffset</span> <span class="p">{</span>
    <span class="n">Size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">Code</span> <span class="o">=</span> <span class="mi">1</span>
<span class="p">}</span>

<span class="k">enum</span> <span class="n">TagOffset</span> <span class="p">{</span>
    <span class="n">Id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">Size</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">ReqResp</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
    <span class="n">StartVal</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
<span class="p">}</span>

<span class="nd">#[repr(C)]</span>
<span class="nd">#[repr(align(</span><span class="mi">16</span><span class="nd">))]</span>
<span class="c">/// Pufferspeicher für Property-Tag-Nachrichten</span>
<span class="k">pub</span> <span class="k">struct</span> <span class="n">PropertyTagBuffer</span> <span class="p">{</span>
    <span class="n">data</span><span class="p">:</span> <span class="p">[</span><span class="nb">u32</span><span class="p">;</span> <span class="n">BUFFER_SIZE</span><span class="p">],</span>
    <span class="n">index</span><span class="p">:</span>    <span class="nb">usize</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">impl</span> <span class="n">PropertyTagBuffer</span> <span class="p">{</span>

    <span class="c">/// Erzeugt einen neuen Puffer.</span>
    <span class="k">pub</span> <span class="k">fn</span> <span class="nf">new</span><span class="p">()</span> <span class="k">-&gt;</span> <span class="n">PropertyTagBuffer</span> <span class="p">{</span>
        <span class="n">PropertyTagBuffer</span><span class="p">{</span>
            <span class="n">data</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">;</span> <span class="n">BUFFER_SIZE</span><span class="p">],</span>
            <span class="n">index</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c">/// Initialisert die Puffer-Struktur</span>
    <span class="k">pub</span> <span class="k">fn</span> <span class="nf">init</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="k">self</span><span class="p">)</span>  <span class="p">{</span>
        <span class="k">self</span><span class="py">.index</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
        <span class="k">self</span><span class="py">.data</span><span class="p">[</span><span class="nn">PbOffset</span><span class="p">::</span><span class="n">Size</span> <span class="k">as</span> <span class="nb">usize</span><span class="p">]</span> <span class="o">=</span> <span class="mi">12</span><span class="p">;</span> <span class="c">// Size + Code + Endtag</span>
        <span class="k">self</span><span class="py">.data</span><span class="p">[</span><span class="nn">PbOffset</span><span class="p">::</span><span class="n">Code</span> <span class="k">as</span> <span class="nb">usize</span><span class="p">]</span> <span class="o">=</span> <span class="nn">ReqResCode</span><span class="p">::</span><span class="n">Request</span> <span class="k">as</span> <span class="nb">u32</span><span class="p">;</span>
        <span class="k">self</span><span class="py">.data</span><span class="p">[</span><span class="k">self</span><span class="py">.index</span><span class="p">]</span> <span class="o">=</span> <span class="nn">Tag</span><span class="p">::</span><span class="nb">None</span> <span class="k">as</span> <span class="nb">u32</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c">/// Schreibt ein einzelnes Wort in den Puffer</span>
    <span class="k">fn</span> <span class="nf">write</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="k">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">u32</span><span class="p">){</span>
        <span class="k">self</span><span class="py">.data</span><span class="p">[</span><span class="k">self</span><span class="py">.index</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
        <span class="k">self</span><span class="py">.data</span><span class="p">[</span><span class="nn">PbOffset</span><span class="p">::</span><span class="n">Size</span> <span class="k">as</span> <span class="nb">usize</span><span class="p">]</span> <span class="o">+=</span> <span class="nn">mem</span><span class="p">::</span><span class="nn">size_of</span><span class="p">::</span><span class="o">&lt;</span><span class="nb">u32</span><span class="o">&gt;</span> <span class="k">as</span> <span class="nb">u32</span><span class="p">;</span>
        <span class="k">self</span><span class="py">.index</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c">/// Fügt einen Tag und ggf. seine Parameter zu den Pufferdaten hinzu.</span>
    <span class="k">pub</span> <span class="k">fn</span> <span class="nf">add_tag_with_param</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="k">self</span><span class="p">,</span> <span class="n">tag</span><span class="p">:</span> <span class="n">Tag</span><span class="p">,</span>  <span class="n">params</span><span class="p">:</span> <span class="nb">Option</span><span class="o">&lt;&amp;</span><span class="p">[</span><span class="nb">u32</span><span class="p">]</span><span class="o">&gt;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">let</span> <span class="n">old_index</span> <span class="o">=</span> <span class="k">self</span><span class="py">.index</span><span class="p">;</span>
        <span class="k">let</span> <span class="n">prop</span> <span class="o">=</span> <span class="nn">ReqProperty</span><span class="p">::</span><span class="nf">new</span><span class="p">(</span><span class="n">tag</span><span class="p">);</span>
        <span class="k">self</span><span class="nf">.write</span><span class="p">(</span><span class="n">prop</span><span class="py">.tag</span> <span class="k">as</span> <span class="nb">u32</span><span class="p">);</span>
        <span class="k">self</span><span class="nf">.write</span><span class="p">(</span><span class="n">prop</span><span class="py">.buf_size</span> <span class="k">as</span> <span class="nb">u32</span><span class="p">);</span>
        <span class="k">self</span><span class="nf">.write</span><span class="p">(</span><span class="nn">TagReqResp</span><span class="p">::</span><span class="n">Request</span> <span class="k">as</span> <span class="nb">u32</span><span class="p">);</span>
        <span class="k">match</span> <span class="n">params</span> <span class="p">{</span>
            <span class="nf">Some</span><span class="p">(</span><span class="n">array</span><span class="p">)</span> <span class="k">=&gt;</span> <span class="p">{</span>
                <span class="k">assert</span><span class="o">!</span><span class="p">(</span><span class="n">array</span><span class="nf">.len</span><span class="p">()</span> <span class="o">==</span> <span class="n">prop</span><span class="py">.param_size</span><span class="p">);</span> <span class="c">// ToDo: Überprüfung zur Compilezeit wäre besser</span>
                <span class="k">for</span> <span class="n">p</span> <span class="n">in</span> <span class="n">array</span><span class="nf">.into_iter</span><span class="p">()</span> <span class="p">{</span>
                    <span class="k">self</span><span class="nf">.write</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">},</span>
            <span class="nb">None</span> <span class="k">=&gt;</span> <span class="p">{}</span>
        <span class="p">}</span>
        <span class="k">self</span><span class="py">.index</span> <span class="o">=</span> <span class="n">old_index</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">+</span> <span class="p">(</span><span class="n">prop</span><span class="py">.buf_size</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">;</span>
        <span class="k">self</span><span class="py">.data</span><span class="p">[</span><span class="k">self</span><span class="py">.index</span><span class="p">]</span> <span class="o">=</span> <span class="nn">Tag</span><span class="p">::</span><span class="nb">None</span> <span class="k">as</span> <span class="nb">u32</span><span class="p">;</span> 
        <span class="k">self</span><span class="py">.data</span><span class="p">[</span><span class="nn">PbOffset</span><span class="p">::</span><span class="n">Size</span> <span class="k">as</span> <span class="nb">usize</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="k">self</span><span class="py">.index</span> <span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="k">as</span> <span class="nb">u32</span><span class="p">;</span> 
    <span class="p">}</span>

    <span class="c">/// Liest ein einzelnes Wort aus dem Puffer</span>
    <span class="k">fn</span> <span class="nf">read</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="k">self</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="nb">u32</span> <span class="p">{</span>
        <span class="k">self</span><span class="py">.index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
        <span class="k">self</span><span class="py">.data</span><span class="p">[</span><span class="k">self</span><span class="py">.index</span> <span class="err">-</span> <span class="mi">1</span><span class="p">]</span>
    <span class="p">}</span>

    <span class="c">/// Liest die Antwort auf eine Tag-Nachricht</span>
    <span class="k">pub</span> <span class="k">fn</span> <span class="nf">get_answer</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="p">,</span> <span class="n">tag</span><span class="p">:</span> <span class="n">Tag</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="nb">Option</span><span class="o">&lt;&amp;</span><span class="p">[</span><span class="nb">u32</span><span class="p">]</span><span class="o">&gt;</span> <span class="p">{</span>
        <span class="k">if</span> <span class="k">self</span><span class="py">.data</span><span class="p">[</span><span class="nn">PbOffset</span><span class="p">::</span><span class="n">Code</span> <span class="k">as</span> <span class="nb">usize</span><span class="p">]</span> <span class="o">!=</span> <span class="nn">ReqResCode</span><span class="p">::</span><span class="nb">Success</span> <span class="k">as</span> <span class="nb">u32</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nb">None</span>
        <span class="p">}</span>
        <span class="c">// Es wird ein lokaler Index benutzt, so dass der PropertyTagBuffer nicht geändert wird</span>
        <span class="k">let</span> <span class="k">mut</span> <span class="n">index</span><span class="p">:</span> <span class="nb">usize</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

        <span class="k">while</span> <span class="p">(</span><span class="n">index</span> <span class="k">as</span> <span class="nb">u32</span><span class="p">)</span> <span class="o">&lt;</span> <span class="p">(</span><span class="k">self</span><span class="py">.data</span><span class="p">[</span><span class="nn">PbOffset</span><span class="p">::</span><span class="n">Size</span> <span class="k">as</span> <span class="nb">usize</span><span class="p">])</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="k">self</span><span class="py">.data</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">==</span> <span class="n">tag</span> <span class="k">as</span> <span class="nb">u32</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
                <span class="p">(</span><span class="k">self</span><span class="py">.data</span><span class="p">[</span><span class="n">index</span> <span class="o">+</span> <span class="nn">TagOffset</span><span class="p">::</span><span class="n">ReqResp</span> <span class="k">as</span> <span class="nb">usize</span><span class="p">]</span> <span class="o">&amp;</span> <span class="nn">TagReqResp</span><span class="p">::</span><span class="n">Response</span> <span class="k">as</span> <span class="nb">u32</span> <span class="o">==</span> <span class="nn">TagReqResp</span><span class="p">::</span><span class="n">Response</span> <span class="k">as</span> <span class="nb">u32</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">let</span> <span class="n">to</span> <span class="o">=</span> <span class="n">index</span> <span class="o">+</span> <span class="nn">TagOffset</span><span class="p">::</span><span class="n">StartVal</span> <span class="k">as</span> <span class="nb">usize</span> <span class="o">+</span>
                    <span class="p">((</span><span class="k">self</span><span class="py">.data</span><span class="p">[</span><span class="n">index</span> <span class="o">+</span> <span class="nn">TagOffset</span><span class="p">::</span><span class="n">Size</span> <span class="k">as</span> <span class="nb">usize</span><span class="p">]</span> <span class="o">&amp;</span> <span class="o">!</span><span class="p">(</span><span class="nn">TagReqResp</span><span class="p">::</span><span class="n">Response</span> <span class="k">as</span> <span class="nb">u32</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="k">as</span> <span class="nb">usize</span><span class="p">;</span>
                <span class="k">let</span> <span class="n">ret</span> <span class="o">=</span> <span class="k">self</span><span class="py">.data</span><span class="nf">.get</span><span class="p">(</span><span class="n">index</span> <span class="o">+</span> <span class="nn">TagOffset</span><span class="p">::</span><span class="n">StartVal</span> <span class="k">as</span> <span class="nb">usize</span> <span class="o">..</span> <span class="n">to</span><span class="p">);</span>
                <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="n">index</span> <span class="o">+=</span> <span class="p">(</span><span class="k">self</span><span class="py">.data</span><span class="p">[</span><span class="n">index</span><span class="o">+</span><span class="nn">TagOffset</span><span class="p">::</span><span class="n">Size</span> <span class="k">as</span> <span class="nb">usize</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="k">as</span> <span class="nb">usize</span> <span class="o">+</span> <span class="mi">3</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="nb">None</span>
    <span class="p">}</span>

    <span class="c">/// Adresse der Puffer-Daten </span>
    <span class="k">pub</span> <span class="k">fn</span> <span class="nf">data_addr</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="nb">usize</span> <span class="p">{</span>
        <span class="o">&amp;</span><span class="k">self</span><span class="py">.data</span> <span class="k">as</span> <span class="o">*</span><span class="k">const</span> <span class="n">_</span> <span class="k">as</span> <span class="nb">usize</span>
    <span class="p">}</span>
<span class="p">}</span></pre></td></tr></tbody></table></code></pre></figure>

<h3 id="zuwenig-speicher">Zuwenig Speicher?</h3>

<p>Mit Hilfe der Property-Tags können jetzt gewünschte Informationen erlangt werden. Um nicht mit den „rohen“ Puffer-Daten umgehen zu müssen, habe ich
Schnittstellenfunktionen geschrieben:</p>

<figure class="highlight"><pre><code class="language-rust" data-lang="rust"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
</pre></td><td class="code"><pre><span class="k">mod</span> <span class="n">uart</span><span class="p">;</span>
<span class="k">pub</span> <span class="k">use</span> <span class="k">self</span><span class="p">::</span><span class="nn">uart</span><span class="p">::</span><span class="o">*</span><span class="p">;</span>
<span class="k">mod</span> <span class="n">aux</span><span class="p">;</span>
<span class="k">pub</span> <span class="k">use</span> <span class="k">self</span><span class="p">::</span><span class="nn">aux</span><span class="p">::{</span><span class="n">MiniUart</span><span class="p">};</span>
<span class="k">mod</span> <span class="n">pl011</span><span class="p">;</span>
<span class="k">pub</span> <span class="k">use</span> <span class="k">self</span><span class="p">::</span><span class="nn">pl011</span><span class="p">::{</span><span class="n">Pl011</span><span class="p">,</span><span class="n">Pl011Interrupt</span><span class="p">,</span><span class="n">Pl011Flag</span><span class="p">,</span><span class="n">Pl011Error</span><span class="p">,</span><span class="n">Pl011FillLevel</span><span class="p">};</span>
<span class="k">mod</span> <span class="n">gpio</span><span class="p">;</span>
<span class="k">pub</span> <span class="k">use</span> <span class="k">self</span><span class="p">::</span><span class="nn">gpio</span><span class="p">::{</span><span class="n">Gpio</span><span class="p">,</span><span class="n">GpioPinFunctions</span><span class="p">,</span><span class="n">GpioPull</span><span class="p">,</span><span class="n">GpioEvent</span><span class="p">,</span><span class="n">gpio_config</span><span class="p">};</span>
<span class="k">mod</span> <span class="n">system_timer</span><span class="p">;</span>
<span class="k">pub</span> <span class="k">use</span> <span class="k">self</span><span class="p">::</span><span class="nn">system_timer</span><span class="p">::</span><span class="n">SystemTimer</span><span class="p">;</span>
    
<span class="k">mod</span> <span class="n">arm_timer</span><span class="p">;</span>
<span class="k">pub</span> <span class="k">use</span> <span class="k">self</span><span class="p">::</span><span class="nn">arm_timer</span><span class="p">::{</span><span class="n">ArmTimer</span><span class="p">,</span><span class="n">ArmTimerResolution</span><span class="p">};</span>
<span class="k">mod</span> <span class="n">interrupts</span><span class="p">;</span>
<span class="k">pub</span> <span class="k">use</span> <span class="k">self</span><span class="p">::</span><span class="nn">interrupts</span><span class="p">::{</span><span class="n">Interrupt</span><span class="p">,</span><span class="n">BasicInterrupt</span><span class="p">,</span><span class="n">GeneralInterrupt</span><span class="p">,</span><span class="n">NUM_INTERRUPTS</span><span class="p">,</span><span class="n">FIRST_BASIC_INTERRUPT</span><span class="p">};</span>
<span class="k">mod</span> <span class="n">irq_controller</span><span class="p">;</span>
<span class="k">pub</span> <span class="k">use</span> <span class="k">self</span><span class="p">::</span><span class="nn">irq_controller</span><span class="p">::</span><span class="n">IrqController</span><span class="p">;</span>
<span class="k">mod</span> <span class="n">led</span><span class="p">;</span>
<span class="k">pub</span> <span class="k">use</span> <span class="k">self</span><span class="p">::</span><span class="nn">led</span><span class="p">::{</span><span class="n">Led</span><span class="p">,</span><span class="n">LedType</span><span class="p">};</span>

<span class="k">mod</span> <span class="n">mailbox</span><span class="p">;</span>
<span class="k">mod</span> <span class="n">propertytags</span><span class="p">;</span>

<span class="k">pub</span> <span class="k">trait</span> <span class="n">Bmc2835</span> <span class="p">{</span>

    <span class="c">/// Basisadresse der Hardwaregeräte.</span>
    <span class="k">fn</span> <span class="nf">device_base</span><span class="p">()</span> <span class="k">-&gt;</span> <span class="nb">usize</span> <span class="p">{</span>
        <span class="c">// Für den RPi 1 reicht eine Konstante.</span>
        <span class="c">// Später sollte hier eine Fallunterscheidung entweder zur Compile-Zeit</span>
        <span class="c">// oder zur Laufzeit gemacht werden.</span>
        <span class="mi">0x20000000</span>
    <span class="p">}</span>

    <span class="c">/// Gerätetypischer Offset der I/O-Adressen.</span>
    <span class="k">fn</span> <span class="nf">base_offset</span><span class="p">()</span> <span class="k">-&gt;</span> <span class="nb">usize</span><span class="p">;</span>

    <span class="c">/// Anfang der I/O-Adressen des Gerätes.</span>
    <span class="k">fn</span> <span class="nf">base</span><span class="p">()</span> <span class="k">-&gt;</span> <span class="nb">usize</span> <span class="p">{</span>
        <span class="nn">Self</span><span class="p">::</span><span class="nf">device_base</span><span class="p">()</span> <span class="o">+</span> <span class="nn">Self</span><span class="p">::</span><span class="nf">base_offset</span><span class="p">()</span>
    <span class="p">}</span>

    <span class="c">/// Gibt den statischen Zeiger auf den I/O-Adressbereichs des Gerätes.</span>
    <span class="k">fn</span> <span class="nf">get</span><span class="p">()</span> <span class="k">-&gt;</span> <span class="o">&amp;</span><span class="nv">'static</span> <span class="k">mut</span> <span class="n">Self</span>
        <span class="n">where</span> <span class="n">Self</span><span class="p">:</span> <span class="n">Sized</span> <span class="p">{</span>
        <span class="k">unsafe</span> <span class="p">{</span>
            <span class="o">&amp;</span><span class="k">mut</span> <span class="o">*</span><span class="p">(</span><span class="nn">Self</span><span class="p">::</span><span class="nf">base</span><span class="p">()</span> <span class="k">as</span> <span class="o">*</span> <span class="k">mut</span> <span class="n">Self</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>

<span class="p">}</span>


<span class="k">pub</span> <span class="k">use</span> <span class="k">self</span><span class="p">::</span><span class="nn">propertytags</span><span class="p">::{</span><span class="n">Tag</span><span class="p">,</span><span class="n">PropertyTagBuffer</span><span class="p">,</span><span class="n">BUFFER_SIZE</span><span class="p">};</span>
<span class="k">pub</span> <span class="k">use</span> <span class="k">self</span><span class="p">::</span><span class="nn">mailbox</span><span class="p">::{</span><span class="n">mailbox</span><span class="p">,</span> <span class="n">Channel</span><span class="p">};</span>

<span class="c">/// Art der verlangten Information</span>
<span class="k">pub</span> <span class="k">enum</span> <span class="n">BoardReport</span> <span class="p">{</span>
    <span class="c">/// Version der Firmware</span>
    <span class="n">FirmwareVersion</span><span class="p">,</span>
    <span class="c">/// Code für den Computertyp (sollte 0 = Raspberry Pi sein)</span>
    <span class="n">BoardModel</span><span class="p">,</span>
    <span class="c">/// Version des Raspberrys</span>
    <span class="n">BoardRevision</span><span class="p">,</span>
    <span class="c">/// Seriennummer</span>
    <span class="n">SerialNumber</span>
<span class="p">}</span>

<span class="c">/// Gibt Informationen über die Hardware</span>
<span class="k">pub</span> <span class="k">fn</span> <span class="nf">report_board_info</span><span class="p">(</span><span class="n">kind</span><span class="p">:</span> <span class="n">BoardReport</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="nb">u32</span> <span class="p">{</span>  
    <span class="k">let</span> <span class="k">mut</span> <span class="n">prob_tag_buf</span><span class="p">:</span> <span class="n">PropertyTagBuffer</span> <span class="o">=</span> <span class="nn">PropertyTagBuffer</span><span class="p">::</span><span class="nf">new</span><span class="p">();</span>
    <span class="n">prob_tag_buf</span><span class="nf">.init</span><span class="p">();</span>
    <span class="k">let</span> <span class="n">tag</span> <span class="o">=</span> <span class="k">match</span> <span class="n">kind</span> <span class="p">{</span>
        <span class="nn">BoardReport</span><span class="p">::</span><span class="n">FirmwareVersion</span> <span class="k">=&gt;</span> <span class="nn">Tag</span><span class="p">::</span><span class="n">GetFirmwareVersion</span><span class="p">,</span>
        <span class="nn">BoardReport</span><span class="p">::</span><span class="n">BoardModel</span>      <span class="k">=&gt;</span> <span class="nn">Tag</span><span class="p">::</span><span class="n">GetBoardModel</span><span class="p">,</span>
        <span class="nn">BoardReport</span><span class="p">::</span><span class="n">BoardRevision</span>   <span class="k">=&gt;</span> <span class="nn">Tag</span><span class="p">::</span><span class="n">GetBoardRevision</span><span class="p">,</span>
        <span class="nn">BoardReport</span><span class="p">::</span><span class="n">SerialNumber</span>    <span class="k">=&gt;</span> <span class="nn">Tag</span><span class="p">::</span><span class="n">GetBoardSerial</span>
    <span class="p">};</span>
    <span class="n">prob_tag_buf</span><span class="nf">.add_tag_with_param</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span><span class="nb">None</span><span class="p">);</span>
    <span class="k">let</span> <span class="n">mb</span> <span class="o">=</span> <span class="nf">mailbox</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="n">mb</span><span class="nf">.write</span><span class="p">(</span><span class="nn">Channel</span><span class="p">::</span><span class="n">ATags</span><span class="p">,</span> <span class="n">prob_tag_buf</span><span class="nf">.data_addr</span><span class="p">()</span> <span class="k">as</span> <span class="nb">u32</span><span class="p">);</span>
    <span class="n">mb</span><span class="nf">.read</span><span class="p">(</span><span class="nn">Channel</span><span class="p">::</span><span class="n">ATags</span><span class="p">);</span>
    <span class="k">match</span> <span class="n">prob_tag_buf</span><span class="nf">.get_answer</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span> <span class="p">{</span>
        <span class="nf">Some</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="k">=&gt;</span> <span class="n">n</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
        <span class="n">_</span>       <span class="k">=&gt;</span> <span class="mi">0</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c">/// </span>
<span class="nd">#[allow(dead_code)]</span>
<span class="k">pub</span> <span class="k">enum</span> <span class="n">MemReport</span> <span class="p">{</span>
    <span class="c">/// Beginn des ARM-Speicherbereiches</span>
    <span class="n">ArmStart</span><span class="p">,</span>
    <span class="c">/// Größe des ARM-Speicherbereiches</span>
    <span class="n">ArmSize</span><span class="p">,</span>
    <span class="c">/// Beginn des Speicherbereiches des Videoprozessors</span>
    <span class="n">VcStart</span><span class="p">,</span>
    <span class="c">/// Größe des Speicherbereiches des Videoprozessors</span>
    <span class="n">VcSize</span><span class="p">,</span>
<span class="p">}</span>

<span class="c">/// Gibt Informationen über die Speicheraufteilung</span>
<span class="k">pub</span> <span class="k">fn</span> <span class="nf">report_memory</span><span class="p">(</span><span class="n">kind</span><span class="p">:</span> <span class="n">MemReport</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="nb">usize</span> <span class="p">{</span>
    <span class="k">let</span> <span class="k">mut</span> <span class="n">prob_tag_buf</span> <span class="o">=</span> <span class="nn">PropertyTagBuffer</span><span class="p">::</span><span class="nf">new</span><span class="p">();</span>
    <span class="n">prob_tag_buf</span><span class="nf">.init</span><span class="p">();</span>
    <span class="k">let</span> <span class="n">tag</span> <span class="o">=</span> <span class="k">match</span> <span class="n">kind</span> <span class="p">{</span>
        <span class="nn">MemReport</span><span class="p">::</span><span class="n">ArmStart</span> <span class="p">|</span> <span class="nn">MemReport</span><span class="p">::</span><span class="n">ArmSize</span> <span class="k">=&gt;</span> <span class="nn">Tag</span><span class="p">::</span><span class="n">GetArmMemory</span><span class="p">,</span>
        <span class="nn">MemReport</span><span class="p">::</span><span class="n">VcStart</span>  <span class="p">|</span> <span class="nn">MemReport</span><span class="p">::</span><span class="n">VcSize</span>  <span class="k">=&gt;</span> <span class="nn">Tag</span><span class="p">::</span><span class="n">GetVcMemory</span>
    <span class="p">};</span>    
    <span class="n">prob_tag_buf</span><span class="nf">.add_tag_with_param</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span><span class="nb">None</span><span class="p">);</span>
    <span class="k">let</span> <span class="n">mb</span> <span class="o">=</span> <span class="nf">mailbox</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="n">mb</span><span class="nf">.write</span><span class="p">(</span><span class="nn">Channel</span><span class="p">::</span><span class="n">ATags</span><span class="p">,</span> <span class="n">prob_tag_buf</span><span class="nf">.data_addr</span><span class="p">()</span> <span class="k">as</span> <span class="nb">u32</span><span class="p">);</span>
    <span class="n">mb</span><span class="nf">.read</span><span class="p">(</span><span class="nn">Channel</span><span class="p">::</span><span class="n">ATags</span><span class="p">);</span>
    <span class="k">let</span> <span class="n">array</span> <span class="o">=</span> <span class="n">prob_tag_buf</span><span class="nf">.get_answer</span><span class="p">(</span><span class="n">tag</span><span class="p">);</span>
    <span class="k">match</span> <span class="n">array</span> <span class="p">{</span>
        <span class="nf">Some</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">=&gt;</span> <span class="k">match</span> <span class="n">kind</span> <span class="p">{</span>
            <span class="nn">MemReport</span><span class="p">::</span><span class="n">ArmStart</span> <span class="p">|</span> <span class="nn">MemReport</span><span class="p">::</span><span class="n">VcStart</span> <span class="k">=&gt;</span> <span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">as</span> <span class="nb">usize</span><span class="p">,</span>
            <span class="nn">MemReport</span><span class="p">::</span><span class="n">ArmSize</span>  <span class="p">|</span> <span class="nn">MemReport</span><span class="p">::</span><span class="n">VcSize</span>  <span class="k">=&gt;</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">as</span> <span class="nb">usize</span>
        <span class="p">},</span>
        <span class="nb">None</span> <span class="k">=&gt;</span> <span class="mi">0</span>
    <span class="p">}</span>
<span class="p">}</span></pre></td></tr></tbody></table></code></pre></figure>

<p>Die Nutzung dieser Funktionen gab für mich zwei Überraschungen:</p>

<ol>
  <li>Bei der Revisionsnummer des Boards hatte ich bei einem Raspberry Pi 1B+ den Wert 0x10 erwartet. Tatsächlich erhielt ich 0x13, der in einigen Verzeichnissen nicht
gelistet ist. <a href="http://elinux.org/RPi_HardwareHistory#Which_Pi_have_I_got.3F">Hier</a> ist eine vermutlich vollständige Liste; demnach handelt es sich tatsächlich um einen 1B+, aber mit geänderten Leiterplattenlayout.</li>
  <li>Es wurden 256 MByte Speicher berichtet, obwohl der 1B+ doch 512 MByte haben sollte, von denen die GPU standardmäßig lediglich 64 MByte „abzweigt“. Eine kurze
Web-Recherche ergab, dass es sich dabei um einen bekannten Bug der Firmware handelt, für den auch ein entsprechender Bugfix existiert. Wenn man in das
Boot-Verzeichnis die Datei <kbd>fixup.dat</kbd> aus dem originalen Boot-Verzeichnis kopiert, werden korrekt 448 MByte verfügbarer Speicher gemeldet.</li>
</ol>

<h2 id="kprint">Kprint</h2>
<p>Der Property-Tags-Kanal der Mailbox hat noch viel mehr parat: Mit Hilfe der Property Tags kann nämlich der Framebuffer konfiguriert werden. <a href="http://sysop.matthias-werner.net/?p=307#morsezeichen">Blinksignale</a> zum Debuggen
sind ja gut und schön, aber ein richtiger Text ist doch bequemer.  Zwar hat die Mailbox dafür auch einen eigenen Kanal, aber der existierte bevor die Property Tags hinzu
kamen und kann nicht ganz soviel wie diese.<sup id="fnref:3"><a href="#fn:3" class="footnote">3</a></sup></p>

<p>Der Framebuffer ist ein Bereich im Speicher, in dem die Bildschirmdaten pixelweise gespeichert sind.<sup id="fnref:4"><a href="#fn:4" class="footnote">4</a></sup> Er kann für verschiedene Bildschirmauflösungen und Farbtiefen
konfiguriert werden. Der Raspberry-Framebuffer unterscheidet zwischen einer virtuellen und einer physischen Bildschirmauflösung. Erstere muss immer größer oder gleich der
physischen Bildschirmauflösung sein. Die physische Bildschirmauflösung ist das sichtbare Fenster, da über die Parameter <code class="highlighter-rouge">x_offset</code> und <code class="highlighter-rouge">y_offset</code> über dem virtuellen
positioniert werden kann.</p>

<p>Zunächst definieren wir eine Struktur:</p>

<figure class="highlight"><pre><code class="language-rust" data-lang="rust"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td><td class="code"><pre><span class="err">#</span><span class="p">[</span><span class="nf">allow</span><span class="p">(</span><span class="n">dead_code</span><span class="p">)]</span>
<span class="k">pub</span> <span class="k">struct</span> <span class="n">Framebuffer</span><span class="o">&lt;</span><span class="nv">'a</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="n">screen</span><span class="p">:</span> <span class="o">&amp;</span><span class="nv">'a</span> <span class="k">mut</span><span class="p">[</span><span class="nb">u32</span><span class="p">],</span>
    <span class="n">width</span><span class="p">:</span> <span class="nb">u32</span><span class="p">,</span>
    <span class="n">height</span><span class="p">:</span> <span class="nb">u32</span><span class="p">,</span>
    <span class="n">depth</span><span class="p">:</span> <span class="nb">u32</span><span class="p">,</span>
    <span class="n">row</span><span class="p">:</span> <span class="nb">u32</span><span class="p">,</span>
    <span class="n">col</span><span class="p">:</span> <span class="nb">u32</span><span class="p">,</span>
    <span class="n">pitch</span><span class="p">:</span> <span class="nb">u32</span><span class="p">,</span>
    <span class="n">fg_color</span><span class="p">:</span> <span class="nb">u32</span><span class="p">,</span>
    <span class="n">bg_color</span><span class="p">:</span> <span class="nb">u32</span><span class="p">,</span>
    <span class="n">virtual_width</span><span class="p">:</span>  <span class="nb">u32</span><span class="p">,</span>
    <span class="n">virtual_height</span><span class="p">:</span> <span class="nb">u32</span><span class="p">,</span>
    <span class="n">x_offset</span><span class="p">:</span> <span class="nb">u32</span><span class="p">,</span>
    <span class="n">y_offset</span><span class="p">:</span> <span class="nb">u32</span><span class="p">,</span>
    <span class="n">size</span><span class="p">:</span> <span class="nb">u32</span><span class="p">,</span>
<span class="p">}</span></pre></td></tr></tbody></table></code></pre></figure>

<p><code class="highlighter-rouge">screen</code> ist dabei die Referenz auf den eigentlichen Framebuffer-Speicherbereich, die anderen Felder sollten selbsterklärend sein. <code class="highlighter-rouge">screen</code> und die resultierende
Speicherzeilenlänge (<code class="highlighter-rouge">pitch</code>) werden bei der Initialisierung abgefragt, nachdem die Grundparameter vorgegeben werden:</p>

<figure class="highlight"><pre><code class="language-rust" data-lang="rust"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
</pre></td><td class="code"><pre><span class="c">/// Legt einen neuen Framebuffer an und setzt die Parameter.</span>
<span class="c">/// Die Voreinstellung des Bootloaders wird ignoriert.</span>
<span class="c">///  *Todo*:  Gegebenenfalls sollten die Einstellungen abgefragt und verwendet werden. Allerdings erfordert dies mindestens</span>
<span class="c">///   bei der Farbtiefe größere Änderungen.</span>
<span class="k">pub</span> <span class="k">fn</span> <span class="nf">new</span><span class="p">()</span> <span class="k">-&gt;</span>  <span class="n">Framebuffer</span><span class="o">&lt;</span><span class="nv">'a</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="c">// Mit der GPU wird über die Mailbox kommuniziert.</span>
    <span class="c">// Es wird das Property-Tag-Interface genutzt, nicht das Framebuffer-Interface.</span>
    <span class="k">let</span> <span class="k">mut</span> <span class="n">prob_tag_buf</span><span class="p">:</span> <span class="n">PropertyTagBuffer</span> <span class="o">=</span> <span class="nn">PropertyTagBuffer</span><span class="p">::</span><span class="nf">new</span><span class="p">();</span>
    <span class="n">prob_tag_buf</span><span class="nf">.init</span><span class="p">();</span>
    <span class="n">prob_tag_buf</span><span class="nf">.add_tag_with_param</span><span class="p">(</span><span class="nn">Tag</span><span class="p">::</span><span class="n">SetPhysicalDisplaySize</span><span class="p">,</span><span class="nf">Some</span><span class="p">(</span><span class="o">&amp;</span><span class="p">[</span><span class="n">FB_WIDTH</span><span class="p">,</span><span class="n">FB_HEIGHT</span><span class="p">]));</span>
    <span class="c">// Der Framebuffer ist doppelt so "hoch" wie der Ausgabebereich, so dass gescrollt werden kann</span>
    <span class="n">prob_tag_buf</span><span class="nf">.add_tag_with_param</span><span class="p">(</span><span class="nn">Tag</span><span class="p">::</span><span class="n">SetVirtualDisplaySize</span><span class="p">,</span><span class="nf">Some</span><span class="p">(</span><span class="o">&amp;</span><span class="p">[</span><span class="n">FB_WIDTH</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="n">FB_HEIGHT</span><span class="p">]));</span>
    <span class="n">prob_tag_buf</span><span class="nf">.add_tag_with_param</span><span class="p">(</span><span class="nn">Tag</span><span class="p">::</span><span class="n">SetDepth</span><span class="p">,</span><span class="nf">Some</span><span class="p">(</span><span class="o">&amp;</span><span class="p">[</span><span class="n">FB_COLOR_DEP</span><span class="p">]));</span>
    <span class="n">prob_tag_buf</span><span class="nf">.add_tag_with_param</span><span class="p">(</span><span class="nn">Tag</span><span class="p">::</span><span class="n">AllocateFrameBuffer</span><span class="p">,</span><span class="nf">Some</span><span class="p">(</span><span class="o">&amp;</span><span class="p">[</span><span class="mi">16</span><span class="p">]));</span>
    <span class="n">prob_tag_buf</span><span class="nf">.add_tag_with_param</span><span class="p">(</span><span class="nn">Tag</span><span class="p">::</span><span class="n">GetPitch</span><span class="p">,</span><span class="nb">None</span><span class="p">);</span>
    <span class="k">let</span> <span class="n">mb</span> <span class="o">=</span> <span class="nf">mailbox</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="n">mb</span><span class="nf">.write</span><span class="p">(</span><span class="nn">Channel</span><span class="p">::</span><span class="n">ATags</span><span class="p">,</span> <span class="n">prob_tag_buf</span><span class="nf">.data_addr</span><span class="p">()</span> <span class="k">as</span> <span class="nb">u32</span><span class="p">);</span>
    <span class="n">mb</span><span class="nf">.read</span><span class="p">(</span><span class="nn">Channel</span><span class="p">::</span><span class="n">ATags</span><span class="p">);</span>
    <span class="c">// Die Antwort enthält die Speicheradresse des Framebuffers</span>
    <span class="k">let</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">prob_tag_buf</span><span class="nf">.get_answer</span><span class="p">(</span><span class="nn">Tag</span><span class="p">::</span><span class="n">AllocateFrameBuffer</span><span class="p">);</span>
    <span class="k">let</span> <span class="n">adr</span><span class="p">:</span> <span class="o">&amp;</span><span class="nv">'a</span> <span class="k">mut</span><span class="p">[</span><span class="nb">u32</span><span class="p">];</span>
    <span class="k">let</span> <span class="n">size</span><span class="p">:</span> <span class="nb">usize</span><span class="p">;</span>
    <span class="k">match</span> <span class="n">ret</span> <span class="p">{</span>
        <span class="nf">Some</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">=&gt;</span> <span class="p">{</span>
            <span class="n">size</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">as</span> <span class="nb">usize</span><span class="p">;</span>
            <span class="n">adr</span>  <span class="o">=</span> <span class="k">unsafe</span><span class="p">{</span> <span class="nn">slice</span><span class="p">::</span><span class="nf">from_raw_parts_mut</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">as</span> <span class="o">*</span><span class="k">mut</span> <span class="nb">u32</span><span class="p">,</span> <span class="n">size</span><span class="p">)};</span>
        <span class="p">}</span>
        <span class="n">_</span>   <span class="k">=&gt;</span> <span class="p">{</span>
            <span class="c">// Wenn etwas schiefgelaufen ist, haben wir keine Konsole zur Fehlerausgabe.</span>
            <span class="c">// Daher wird die LED genutzt</span>
            <span class="nn">blink</span><span class="p">::</span><span class="nf">blink</span><span class="p">(</span><span class="nn">blink</span><span class="p">::</span><span class="n">BS_SOS</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">};</span>
    
    <span class="k">let</span> <span class="n">pitch</span><span class="p">:</span> <span class="nb">u32</span><span class="p">;</span>
    <span class="k">let</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">prob_tag_buf</span><span class="nf">.get_answer</span><span class="p">(</span><span class="nn">Tag</span><span class="p">::</span><span class="n">GetPitch</span><span class="p">);</span>
    <span class="k">match</span> <span class="n">ret</span> <span class="p">{</span>
        <span class="nf">Some</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">=&gt;</span> <span class="p">{</span>
            <span class="n">pitch</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
        <span class="p">}</span>
        <span class="n">_</span> <span class="k">=&gt;</span> <span class="p">{</span>
            <span class="nn">blink</span><span class="p">::</span><span class="nf">blink</span><span class="p">(</span><span class="nn">blink</span><span class="p">::</span><span class="n">BS_SOS</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>        
    <span class="k">let</span> <span class="n">fb</span> <span class="o">=</span> <span class="n">Framebuffer</span> <span class="p">{</span>
        <span class="n">screen</span><span class="p">:</span> <span class="n">adr</span><span class="p">,</span>
        <span class="n">width</span><span class="p">:</span> <span class="n">FB_WIDTH</span><span class="p">,</span>
        <span class="n">height</span><span class="p">:</span> <span class="n">FB_HEIGHT</span><span class="p">,</span>
        <span class="n">depth</span><span class="p">:</span> <span class="n">FB_COLOR_DEP</span><span class="p">,</span>
        <span class="n">row</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="n">col</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">pitch</span><span class="p">:</span> <span class="n">pitch</span><span class="p">,</span>
        <span class="n">fg_color</span><span class="p">:</span> <span class="n">DEF_COLOR</span><span class="p">,</span> <span class="n">bg_color</span><span class="p">:</span> <span class="n">DEF_BG_COLOR</span><span class="p">,</span>
        <span class="n">virtual_width</span><span class="p">:</span> <span class="n">FB_WIDTH</span><span class="p">,</span>
        <span class="n">virtual_height</span><span class="p">:</span> <span class="mi">2</span><span class="o">*</span><span class="n">FB_HEIGHT</span><span class="p">,</span>
        <span class="n">x_offset</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">y_offset</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">size</span><span class="p">:</span> <span class="n">size</span> <span class="k">as</span> <span class="nb">u32</span><span class="p">,</span>
    <span class="p">};</span>
    <span class="n">fb</span>
<span class="p">}</span></pre></td></tr></tbody></table></code></pre></figure>

<p>Wir wählen einen virtuellen Puffer, der doppelt so hoch ist wie die vertikale Bildschirmauflösung. Damit können wir ein kontinuierliches Scrollen erreichen,<sup id="fnref:5"><a href="#fn:5" class="footnote">5</a></sup> indem wir
einen virtuellen Ringpuffer aufbauen, siehe Abschnitt „<a href="#scrollen">Scrollen</a>“.</p>

<p><img src="http://sysop.matthias-werner.net/images/virphys-fb.png" alt="" class="img-responsive" /></p>
<h3 id="vom-pixel-zum-string">Vom Pixel zum String</h3>

<p>Wenn jetzt ein Pixel in einer bestimmten Farbe dargestellt werden soll, muss entsprechender Wert in den Puffer geschrieben werden. Der Farbwert (im eingestellten Modus) setzt sich folgendermaßen zusammen:</p>

<table>
  <thead>
    <tr>
      <th><strong>Bit</strong></th>
      <th style="text-align: center"><strong>24 – 31</strong></th>
      <th style="text-align: center"><strong>16 – 23</strong></th>
      <th style="text-align: center"><strong>8 – 15</strong></th>
      <th style="text-align: left"><strong>0 – 7</strong></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td> </td>
      <td style="text-align: center">Transparenz</td>
      <td style="text-align: center">Rotanteil</td>
      <td style="text-align: center">Grünanteil</td>
      <td style="text-align: left">Blauanteil</td>
    </tr>
    <tr>
      <td> </td>
      <td style="text-align: center">(nicht genutzt)</td>
      <td style="text-align: center">(0–255)</td>
      <td style="text-align: center">(0–255)</td>
      <td style="text-align: left">(0–255)</td>
    </tr>
  </tbody>
</table>

<figure class="highlight"><pre><code class="language-rust" data-lang="rust"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="code"><pre><span class="c">/// gegebene Position</span>
<span class="k">fn</span> <span class="nf">draw_pixel</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="k">self</span><span class="p">,</span> <span class="n">color</span><span class="p">:</span> <span class="nb">u32</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="nb">u32</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="nb">u32</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">self</span><span class="py">.screen</span><span class="p">[(</span><span class="n">y</span><span class="o">*</span><span class="k">self</span><span class="py">.width</span> <span class="o">+</span> <span class="n">x</span><span class="p">)</span> <span class="k">as</span> <span class="nb">usize</span><span class="p">]</span> <span class="o">=</span>  <span class="n">color</span><span class="p">;</span>
<span class="p">}</span></pre></td></tr></tbody></table></code></pre></figure>

<p>Jetzt zeigt es sich von Vorteil, dass wir eine Farbtiefe gewählt haben, die der Wortbreite entspricht: Dadurch wird die Indexierung sehr einfach. Bei 24 Bit Farbtiefe,
die z.B. auch möglich ist, wäre es etwas aufwendiger gewesen.<sup id="fnref:6"><a href="#fn:6" class="footnote">6</a></sup>  Damit wir auch Text ausgeben können, brauchen wir einen Font. Freundlicherweise hat auf
<a href="http://stackoverflow.com/a/23130671">Stackoverflow</a> jemand einen kompletten ASCII-Font für C bereit gestellt, der für <img alt="aihPOS" style="height:.78em; vertical-align:baseline" src="/assets/img/sophia.png"> einfach an Rust angepasst und um die deutschen Umlaute erweitert wurde:</p>

<figure class="highlight"><pre><code class="language-rust" data-lang="rust"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre></td><td class="code"><pre><span class="c">// Die Daten für diesen Font stammen von http://stackoverflow.com/a/23130671, mit kleinen Modifikationen</span>
<span class="k">pub</span> <span class="k">trait</span> <span class="n">Font</span> <span class="p">{</span>
    <span class="k">fn</span> <span class="nf">glyph_width</span><span class="p">()</span>  <span class="k">-&gt;</span> <span class="nb">u32</span><span class="p">;</span>
    <span class="k">fn</span> <span class="nf">glyph_height</span><span class="p">()</span> <span class="k">-&gt;</span> <span class="nb">u32</span><span class="p">;</span>
    <span class="k">fn</span> <span class="nf">glyph_pixel</span><span class="p">(</span><span class="nb">char</span><span class="p">:</span> <span class="nb">u8</span><span class="p">,</span> <span class="n">row</span><span class="p">:</span> <span class="nb">u32</span><span class="p">,</span> <span class="n">col</span><span class="p">:</span> <span class="nb">u32</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="nb">Option</span><span class="o">&lt;</span><span class="nb">bool</span><span class="o">&gt;</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">pub</span> <span class="k">struct</span> <span class="n">SystemFont</span> <span class="p">{}</span>

<span class="k">impl</span> <span class="n">Font</span> <span class="k">for</span> <span class="n">SystemFont</span> <span class="p">{</span>
    <span class="k">fn</span> <span class="nf">glyph_width</span><span class="p">()</span> <span class="k">-&gt;</span> <span class="nb">u32</span> <span class="p">{</span><span class="mi">8</span><span class="p">}</span>
    <span class="k">fn</span> <span class="nf">glyph_height</span><span class="p">()</span> <span class="k">-&gt;</span> <span class="nb">u32</span> <span class="p">{</span><span class="mi">13</span><span class="p">}</span>
    <span class="k">fn</span> <span class="nf">glyph_pixel</span><span class="p">(</span><span class="nb">char</span><span class="p">:</span> <span class="nb">u8</span><span class="p">,</span> <span class="n">row</span><span class="p">:</span> <span class="nb">u32</span><span class="p">,</span> <span class="n">col</span><span class="p">:</span> <span class="nb">u32</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="nb">Option</span><span class="o">&lt;</span><span class="nb">bool</span><span class="o">&gt;</span>  <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">row</span> <span class="o">&gt;=</span> <span class="nn">Self</span><span class="p">::</span><span class="nf">glyph_height</span><span class="p">())</span> <span class="p">||</span> <span class="p">(</span><span class="n">col</span> <span class="o">&gt;=</span> <span class="nn">Self</span><span class="p">::</span><span class="nf">glyph_width</span><span class="p">())</span> <span class="p">{</span> <span class="k">return</span> <span class="nb">None</span> <span class="p">};</span>
        <span class="k">let</span> <span class="n">glyph</span> <span class="o">=</span>
        <span class="k">match</span> <span class="nb">char</span> <span class="p">{</span>
            <span class="mi">32</span>  <span class="k">=&gt;</span><span class="p">[</span><span class="mi">0x00u8</span><span class="p">,</span> <span class="mi">0x00u8</span><span class="p">,</span> <span class="mi">0x00u8</span><span class="p">,</span> <span class="mi">0x00u8</span><span class="p">,</span> <span class="mi">0x00u8</span><span class="p">,</span> <span class="mi">0x00u8</span><span class="p">,</span> <span class="mi">0x00u8</span><span class="p">,</span> <span class="mi">0x00u8</span><span class="p">,</span> <span class="mi">0x00u8</span><span class="p">,</span> <span class="mi">0x00u8</span><span class="p">,</span> <span class="mi">0x00u8</span><span class="p">,</span> <span class="mi">0x00u8</span><span class="p">,</span> <span class="mi">0x00u8</span><span class="p">],</span><span class="c">// space</span>
            <span class="mi">33</span> <span class="k">=&gt;</span> <span class="p">[</span><span class="mi">0x00u8</span><span class="p">,</span> <span class="mi">0x00u8</span><span class="p">,</span> <span class="mi">0x18u8</span><span class="p">,</span> <span class="mi">0x18u8</span><span class="p">,</span> <span class="mi">0x00u8</span><span class="p">,</span> <span class="mi">0x00u8</span><span class="p">,</span> <span class="mi">0x18u8</span><span class="p">,</span> <span class="mi">0x18u8</span><span class="p">,</span> <span class="mi">0x18u8</span><span class="p">,</span> <span class="mi">0x18u8</span><span class="p">,</span> <span class="mi">0x18u8</span><span class="p">,</span> <span class="mi">0x18u8</span><span class="p">,</span> <span class="mi">0x18u8</span><span class="p">],</span><span class="c">// ! </span>
            <span class="mi">34</span> <span class="k">=&gt;</span> <span class="p">[</span><span class="mi">0x00u8</span><span class="p">,</span> <span class="mi">0x00u8</span><span class="p">,</span> <span class="mi">0x00u8</span><span class="p">,</span> <span class="mi">0x00u8</span><span class="p">,</span> <span class="mi">0x00u8</span><span class="p">,</span> <span class="mi">0x00u8</span><span class="p">,</span> <span class="mi">0x00u8</span><span class="p">,</span> <span class="mi">0x00u8</span><span class="p">,</span> <span class="mi">0x00u8</span><span class="p">,</span> <span class="mi">0x36u8</span><span class="p">,</span> <span class="mi">0x36u8</span><span class="p">,</span> <span class="mi">0x36u8</span><span class="p">,</span> <span class="mi">0x36u8</span><span class="p">],</span><span class="c">// "</span>
            <span class="mi">35</span> <span class="k">=&gt;</span> <span class="p">[</span><span class="mi">0x00u8</span><span class="p">,</span> <span class="mi">0x00u8</span><span class="p">,</span> <span class="mi">0x00u8</span><span class="p">,</span> <span class="mi">0x66u8</span><span class="p">,</span> <span class="mi">0x66u8</span><span class="p">,</span> <span class="mi">0xffu8</span><span class="p">,</span> <span class="mi">0x66u8</span><span class="p">,</span> <span class="mi">0x66u8</span><span class="p">,</span> <span class="mi">0xffu8</span><span class="p">,</span> <span class="mi">0x66u8</span><span class="p">,</span> <span class="mi">0x66u8</span><span class="p">,</span> <span class="mi">0x00u8</span><span class="p">,</span> <span class="mi">0x00u8</span><span class="p">],</span><span class="c">// #</span>
            <span class="mi">36</span> <span class="k">=&gt;</span> <span class="p">[</span><span class="mi">0x00u8</span><span class="p">,</span> <span class="mi">0x00u8</span><span class="p">,</span> <span class="mi">0x18u8</span><span class="p">,</span> <span class="mi">0x7eu8</span><span class="p">,</span> <span class="mi">0xffu8</span><span class="p">,</span> <span class="mi">0x1bu8</span><span class="p">,</span> <span class="mi">0x1fu8</span><span class="p">,</span> <span class="mi">0x7eu8</span><span class="p">,</span> <span class="mi">0xf8u8</span><span class="p">,</span> <span class="mi">0xd8u8</span><span class="p">,</span> <span class="mi">0xffu8</span><span class="p">,</span> <span class="mi">0x7eu8</span><span class="p">,</span> <span class="mi">0x18u8</span><span class="p">],</span></pre></td></tr></tbody></table></code></pre></figure>

<p>…</p>

<figure class="highlight"><pre><code class="language-rust" data-lang="rust"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre></td><td class="code"><pre><span class="mi">124</span> <span class="k">=&gt;</span> <span class="p">[</span><span class="mi">0x18u8</span><span class="p">,</span> <span class="mi">0x18u8</span><span class="p">,</span> <span class="mi">0x18u8</span><span class="p">,</span> <span class="mi">0x18u8</span><span class="p">,</span> <span class="mi">0x18u8</span><span class="p">,</span> <span class="mi">0x18u8</span><span class="p">,</span> <span class="mi">0x18u8</span><span class="p">,</span> <span class="mi">0x18u8</span><span class="p">,</span> <span class="mi">0x18u8</span><span class="p">,</span> <span class="mi">0x18u8</span><span class="p">,</span> <span class="mi">0x18u8</span><span class="p">,</span> <span class="mi">0x18u8</span><span class="p">,</span> <span class="mi">0x18u8</span><span class="p">],</span><span class="c">// |</span>
            <span class="mi">125</span> <span class="k">=&gt;</span> <span class="p">[</span><span class="mi">0x00u8</span><span class="p">,</span> <span class="mi">0x00u8</span><span class="p">,</span> <span class="mi">0xf0u8</span><span class="p">,</span> <span class="mi">0x18u8</span><span class="p">,</span> <span class="mi">0x18u8</span><span class="p">,</span> <span class="mi">0x18u8</span><span class="p">,</span> <span class="mi">0x1cu8</span><span class="p">,</span> <span class="mi">0x0fu8</span><span class="p">,</span> <span class="mi">0x1cu8</span><span class="p">,</span> <span class="mi">0x18u8</span><span class="p">,</span> <span class="mi">0x18u8</span><span class="p">,</span> <span class="mi">0x18u8</span><span class="p">,</span> <span class="mi">0xf0u8</span><span class="p">],</span><span class="c">// }</span>
            <span class="c">// Umlaute</span>
            <span class="mi">228</span> <span class="k">=&gt;</span> <span class="p">[</span><span class="mi">0x00u8</span><span class="p">,</span> <span class="mi">0x00u8</span><span class="p">,</span> <span class="mi">0x7fu8</span><span class="p">,</span> <span class="mi">0xc3u8</span><span class="p">,</span> <span class="mi">0xc3u8</span><span class="p">,</span> <span class="mi">0x7fu8</span><span class="p">,</span> <span class="mi">0x03u8</span><span class="p">,</span> <span class="mi">0xc3u8</span><span class="p">,</span> <span class="mi">0x7eu8</span><span class="p">,</span> <span class="mi">0x00u8</span><span class="p">,</span> <span class="mi">0x00u8</span><span class="p">,</span> <span class="mi">0xc6u8</span><span class="p">,</span> <span class="mi">0x00u8</span><span class="p">],</span><span class="c">// ä</span>
            <span class="mi">252</span> <span class="k">=&gt;</span> <span class="p">[</span><span class="mi">0x00u8</span><span class="p">,</span> <span class="mi">0x00u8</span><span class="p">,</span> <span class="mi">0x7eu8</span><span class="p">,</span> <span class="mi">0xc6u8</span><span class="p">,</span> <span class="mi">0xc6u8</span><span class="p">,</span> <span class="mi">0xc6u8</span><span class="p">,</span> <span class="mi">0xc6u8</span><span class="p">,</span> <span class="mi">0xc6u8</span><span class="p">,</span> <span class="mi">0xc6u8</span><span class="p">,</span> <span class="mi">0x00u8</span><span class="p">,</span> <span class="mi">0x00u8</span><span class="p">,</span> <span class="mi">0xc6u8</span><span class="p">,</span> <span class="mi">0x00u8</span><span class="p">],</span><span class="c">// ü</span>
            <span class="mi">246</span> <span class="k">=&gt;</span> <span class="p">[</span><span class="mi">0x00u8</span><span class="p">,</span> <span class="mi">0x00u8</span><span class="p">,</span> <span class="mi">0x7cu8</span><span class="p">,</span> <span class="mi">0xc6u8</span><span class="p">,</span> <span class="mi">0xc6u8</span><span class="p">,</span> <span class="mi">0xc6u8</span><span class="p">,</span> <span class="mi">0xc6u8</span><span class="p">,</span> <span class="mi">0xc6u8</span><span class="p">,</span> <span class="mi">0x7cu8</span><span class="p">,</span> <span class="mi">0x00u8</span><span class="p">,</span> <span class="mi">0x00u8</span><span class="p">,</span> <span class="mi">0xc6u8</span><span class="p">,</span> <span class="mi">0x00u8</span><span class="p">],</span><span class="c">// ö</span>
            <span class="mi">196</span> <span class="k">=&gt;</span> <span class="p">[</span><span class="mi">0x00u8</span><span class="p">,</span> <span class="mi">0x00u8</span><span class="p">,</span> <span class="mi">0xc3u8</span><span class="p">,</span> <span class="mi">0xc3u8</span><span class="p">,</span> <span class="mi">0xc3u8</span><span class="p">,</span> <span class="mi">0xc3u8</span><span class="p">,</span> <span class="mi">0xffu8</span><span class="p">,</span> <span class="mi">0xc3u8</span><span class="p">,</span> <span class="mi">0xc3u8</span><span class="p">,</span> <span class="mi">0xc3u8</span><span class="p">,</span> <span class="mi">0x66u8</span><span class="p">,</span> <span class="mi">0x3cu8</span><span class="p">,</span> <span class="mi">0xc3u8</span><span class="p">],</span><span class="c">// Ä</span>
            <span class="mi">220</span> <span class="k">=&gt;</span> <span class="p">[</span><span class="mi">0x00u8</span><span class="p">,</span> <span class="mi">0x00u8</span><span class="p">,</span> <span class="mi">0x7eu8</span><span class="p">,</span> <span class="mi">0xe7u8</span><span class="p">,</span> <span class="mi">0xc3u8</span><span class="p">,</span> <span class="mi">0xc3u8</span><span class="p">,</span> <span class="mi">0xc3u8</span><span class="p">,</span> <span class="mi">0xc3u8</span><span class="p">,</span> <span class="mi">0xc3u8</span><span class="p">,</span> <span class="mi">0xc3u8</span><span class="p">,</span> <span class="mi">0xc3u8</span><span class="p">,</span> <span class="mi">0x00u8</span><span class="p">,</span> <span class="mi">0xc3u8</span><span class="p">],</span><span class="c">// Ü</span>
            <span class="mi">214</span> <span class="k">=&gt;</span> <span class="p">[</span><span class="mi">0x00u8</span><span class="p">,</span> <span class="mi">0x00u8</span><span class="p">,</span> <span class="mi">0x7eu8</span><span class="p">,</span> <span class="mi">0xe7u8</span><span class="p">,</span> <span class="mi">0xc3u8</span><span class="p">,</span> <span class="mi">0xc3u8</span><span class="p">,</span> <span class="mi">0xc3u8</span><span class="p">,</span> <span class="mi">0xc3u8</span><span class="p">,</span> <span class="mi">0xc3u8</span><span class="p">,</span> <span class="mi">0xe7u8</span><span class="p">,</span> <span class="mi">0xfeu8</span><span class="p">,</span> <span class="mi">0x3cu8</span><span class="p">,</span> <span class="mi">0xc3u8</span><span class="p">],</span><span class="c">// Ö</span>
            <span class="mi">223</span> <span class="k">=&gt;</span> <span class="p">[</span><span class="mi">0xc0u8</span><span class="p">,</span> <span class="mi">0xc0u8</span><span class="p">,</span> <span class="mi">0xceu8</span><span class="p">,</span> <span class="mi">0xc7u8</span><span class="p">,</span> <span class="mi">0xc3u8</span><span class="p">,</span> <span class="mi">0xc3u8</span><span class="p">,</span> <span class="mi">0xc7u8</span><span class="p">,</span> <span class="mi">0xceu8</span><span class="p">,</span> <span class="mi">0xc7u8</span><span class="p">,</span> <span class="mi">0xc3u8</span><span class="p">,</span> <span class="mi">0xc3u8</span><span class="p">,</span> <span class="mi">0x67u8</span><span class="p">,</span> <span class="mi">0x3eu8</span><span class="p">],</span><span class="c">// ß</span>
            <span class="n">_</span> <span class="k">=&gt;</span> <span class="p">[</span><span class="mi">0x00u8</span><span class="p">,</span> <span class="mi">0x00u8</span><span class="p">,</span> <span class="mi">0x00u8</span><span class="p">,</span> <span class="mi">0x00u8</span><span class="p">,</span> <span class="mi">0x00u8</span><span class="p">,</span> <span class="mi">0x00u8</span><span class="p">,</span> <span class="mi">0x06u8</span><span class="p">,</span> <span class="mi">0x8fu8</span><span class="p">,</span> <span class="mi">0xf1u8</span><span class="p">,</span> <span class="mi">0x60u8</span><span class="p">,</span> <span class="mi">0x00u8</span><span class="p">,</span> <span class="mi">0x00u8</span><span class="p">,</span> <span class="mi">0x00u8</span><span class="p">],</span>
            
        <span class="p">};</span>
        <span class="k">let</span> <span class="n">glyph_row</span> <span class="o">=</span> <span class="n">glyph</span><span class="p">[</span><span class="n">row</span> <span class="k">as</span> <span class="nb">usize</span><span class="p">];</span>
        <span class="k">let</span> <span class="n">val</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="p">(</span><span class="n">glyph_row</span> <span class="o">&gt;&gt;</span> <span class="n">col</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">0x1</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="nf">Some</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span></pre></td></tr></tbody></table></code></pre></figure>

<p>Ein Textstring kann jetzt im Framebuffer Zeichen für Zeichen, ein Zeichen ggf. interpretiert und dann pixelweise ausgegeben werden. Dabei wird immer Buch über die
aktuelle Zeichenposition – d.h. Spalte und Zeile – geführt und entsprechend angepasst. Bei der Interpretation beschränken wir uns erst einmal auf die
Steuerzeichen für „neue Zeile“und „Tabulator“.</p>

<figure class="highlight"><pre><code class="language-rust" data-lang="rust"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
</pre></td><td class="code"><pre><span class="k">pub</span> <span class="k">fn</span> <span class="nf">print</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="k">self</span><span class="p">,</span> <span class="n">s</span><span class="p">:</span> <span class="o">&amp;</span><span class="nb">str</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">for</span> <span class="n">c</span> <span class="n">in</span> <span class="n">s</span><span class="nf">.chars</span><span class="p">()</span> <span class="p">{</span>
                <span class="k">self</span><span class="nf">.putchar</span><span class="p">(</span><span class="n">c</span> <span class="k">as</span> <span class="nb">u8</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">pub</span> <span class="k">fn</span> <span class="nf">putchar</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="k">self</span><span class="p">,</span> <span class="n">c</span><span class="p">:</span> <span class="nb">u8</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">self</span><span class="py">.row</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="nn">SystemFont</span><span class="p">::</span><span class="nf">glyph_height</span><span class="p">()</span> <span class="err">-</span> <span class="k">self</span><span class="py">.y_offset</span> <span class="o">&gt;</span> <span class="k">self</span><span class="py">.height</span> <span class="p">{</span>
            <span class="k">self</span><span class="nf">.scroll</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="k">match</span> <span class="n">c</span> <span class="k">as</span> <span class="nb">char</span> <span class="p">{</span>
            <span class="sc">'\n'</span> <span class="k">=&gt;</span> <span class="p">{</span>
                <span class="k">self</span><span class="py">.row</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
                <span class="k">self</span><span class="py">.col</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="p">},</span>
            <span class="sc">'\t'</span>  <span class="k">=&gt;</span> <span class="p">{</span>
                <span class="k">for</span> <span class="n">_</span> <span class="n">in</span> <span class="mi">0</span><span class="o">..</span><span class="mi">4</span> <span class="p">{</span>
                    <span class="k">self</span><span class="nf">.putchar</span><span class="p">(</span><span class="sc">' '</span> <span class="k">as</span> <span class="nb">u8</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">},</span>
            <span class="n">_</span> <span class="k">=&gt;</span> <span class="p">{</span>
                <span class="k">let</span> <span class="p">(</span><span class="n">icol</span><span class="p">,</span><span class="n">irow</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="k">self</span><span class="py">.col</span><span class="p">,</span> <span class="k">self</span><span class="py">.row</span><span class="p">);</span> <span class="c">// Copy </span>
                <span class="k">self</span><span class="nf">.draw_glyph</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">icol</span> <span class="o">*</span> <span class="p">(</span><span class="nn">SystemFont</span><span class="p">::</span><span class="nf">glyph_width</span><span class="p">()</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">irow</span> <span class="o">*</span> <span class="nn">SystemFont</span><span class="p">::</span><span class="nf">glyph_height</span><span class="p">());</span>
                
                <span class="k">self</span><span class="py">.col</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
                <span class="k">if</span> <span class="k">self</span><span class="py">.col</span> <span class="o">*</span> <span class="p">(</span><span class="nn">SystemFont</span><span class="p">::</span><span class="nf">glyph_width</span><span class="p">()</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="k">self</span><span class="py">.width</span> <span class="p">{</span>
                    <span class="k">self</span><span class="py">.row</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
                    <span class="k">self</span><span class="py">.col</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">pub</span> <span class="k">fn</span> <span class="nf">draw_glyph</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="k">self</span><span class="p">,</span> <span class="nb">char</span><span class="p">:</span> <span class="nb">u8</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="nb">u32</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="nb">u32</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">for</span> <span class="n">row</span> <span class="n">in</span> <span class="mi">0</span><span class="o">..</span><span class="nn">SystemFont</span><span class="p">::</span><span class="nf">glyph_height</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">for</span> <span class="n">col</span> <span class="n">in</span> <span class="mi">0</span><span class="o">..</span><span class="nn">SystemFont</span><span class="p">::</span><span class="nf">glyph_width</span><span class="p">()</span> <span class="p">{</span>
                <span class="k">let</span> <span class="n">p</span> <span class="o">=</span> <span class="nn">SystemFont</span><span class="p">::</span><span class="nf">glyph_pixel</span><span class="p">(</span><span class="nb">char</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">col</span> <span class="p">)</span> <span class="p">;</span>
                <span class="k">let</span> <span class="n">color</span> <span class="o">=</span> <span class="k">match</span> <span class="n">p</span> <span class="p">{</span>
                    <span class="nf">Some</span><span class="p">(</span><span class="k">true</span><span class="p">)</span> <span class="k">=&gt;</span> <span class="k">self</span><span class="py">.fg_color</span><span class="p">,</span>
                    <span class="n">_</span> <span class="k">=&gt;</span> <span class="k">self</span><span class="py">.bg_color</span>
                <span class="p">};</span>
                <span class="k">self</span><span class="nf">.draw_pixel</span><span class="p">(</span><span class="n">color</span><span class="p">,</span> <span class="n">x</span> <span class="o">+</span> <span class="nn">SystemFont</span><span class="p">::</span><span class="nf">glyph_width</span><span class="p">()</span> <span class="err">-</span> <span class="mi">1</span> <span class="err">-</span> <span class="n">col</span><span class="p">,</span> <span class="n">y</span> <span class="o">+</span> <span class="nn">SystemFont</span><span class="p">::</span><span class="nf">glyph_height</span><span class="p">()</span> <span class="err">-</span> <span class="mi">1</span> <span class="err">-</span> <span class="n">row</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span></pre></td></tr></tbody></table></code></pre></figure>

<p>Für die formatierte Ausgabe von Werten kann bequemerweise die Rust-Core-Bibliothek genutzt werden. Dazu muss unser Framebuffer den Trait <code class="highlighter-rouge">fmt::Write</code> implementieren:</p>

<figure class="highlight"><pre><code class="language-rust" data-lang="rust"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="code"><pre><span class="k">impl</span><span class="o">&lt;</span><span class="nv">'a</span><span class="o">&gt;</span> <span class="nn">fmt</span><span class="p">::</span><span class="n">Write</span> <span class="k">for</span> <span class="n">Framebuffer</span><span class="o">&lt;</span><span class="nv">'a</span><span class="o">&gt;</span> <span class="p">{</span> 
    <span class="k">fn</span> <span class="nf">write_str</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="k">self</span><span class="p">,</span> <span class="n">s</span><span class="p">:</span> <span class="o">&amp;</span><span class="nb">str</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="nn">fmt</span><span class="p">::</span><span class="n">Result</span> <span class="p">{</span>
        <span class="k">self</span><span class="nf">.print</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
         <span class="nf">Ok</span><span class="p">(())</span>
    <span class="p">}</span>
<span class="p">}</span></pre></td></tr></tbody></table></code></pre></figure>

<h3 id="scrollen">Scrollen</h3>

<p>Nun muss noch die Scroll-Logik implementiert werden. Die Idee ist sehr einfach: Die eigentliche Verschiebung erfolgt auch die Änderung von <code class="highlighter-rouge">y_offset</code>, wofür wieder die
Mailbox benutzt wird. Sobald das sichtbare Fenster nach unten geschoben wurde, wird eine Bildschirmzeile nach oben in den jetzt verstecken Bereich kopiert. Der noch nicht
sichtbare Bereich unten wird von evtl. vorhandenen alten Daten bereinigt. Wenn die maximale Verschiebung erreicht ist, springt der sichtbare Ausschnitt wieder nach oben,
was durch das vorherige Kopieren aber wie ein einfaches Scrollen aussieht.</p>

<figure class="highlight"><pre><code class="language-rust" data-lang="rust"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
</pre></td><td class="code"><pre><span class="k">pub</span> <span class="k">fn</span> <span class="nf">scroll</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="k">self</span><span class="p">)</span> <span class="p">{</span>
        <span class="c">// kopiere letzte Zeile</span>
        <span class="k">if</span> <span class="k">self</span><span class="py">.y_offset</span> <span class="o">&gt;</span> <span class="nn">SystemFont</span><span class="p">::</span><span class="nf">glyph_height</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">for</span> <span class="n">y</span> <span class="n">in</span> <span class="k">self</span><span class="py">.y_offset</span> <span class="err">-</span><span class="mi">2</span><span class="o">*</span><span class="nn">SystemFont</span><span class="p">::</span><span class="nf">glyph_height</span><span class="p">()</span><span class="o">..</span><span class="k">self</span><span class="py">.y_offset</span> <span class="err">-</span> <span class="nn">SystemFont</span><span class="p">::</span><span class="nf">glyph_height</span><span class="p">()</span> <span class="p">{</span>
                <span class="k">for</span> <span class="n">x</span> <span class="n">in</span> <span class="mi">0</span><span class="o">..</span><span class="k">self</span><span class="py">.width</span> <span class="p">{</span>
                    <span class="k">self</span><span class="py">.screen</span><span class="p">[(</span><span class="n">y</span><span class="o">*</span><span class="k">self</span><span class="py">.width</span> <span class="o">+</span><span class="n">x</span><span class="p">)</span> <span class="k">as</span> <span class="nb">usize</span><span class="p">]</span> <span class="o">=</span> <span class="k">self</span><span class="py">.screen</span><span class="p">[((</span><span class="n">y</span><span class="o">+</span><span class="k">self</span><span class="py">.height</span><span class="o">+</span><span class="nn">SystemFont</span><span class="p">::</span><span class="nf">glyph_height</span><span class="p">()</span><span class="err">-</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="k">self</span><span class="py">.width</span> <span class="o">+</span><span class="n">x</span><span class="p">)</span> <span class="k">as</span> <span class="nb">usize</span><span class="p">];</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="k">self</span><span class="py">.y_offset</span> <span class="o">+</span> <span class="nn">SystemFont</span><span class="p">::</span><span class="nf">glyph_height</span><span class="p">()</span> <span class="o">&lt;</span> <span class="k">self</span><span class="py">.height</span> <span class="p">{</span> <span class="c">// solange das Fenster noch nicht das Ende des Puffers erreicht hat...</span>
            <span class="c">// lösche ggf. alten Inhalt</span>
            <span class="k">for</span> <span class="n">y</span> <span class="nf">in</span> <span class="p">(</span><span class="k">self</span><span class="py">.height</span><span class="o">+</span><span class="k">self</span><span class="py">.y_offset</span><span class="p">)</span><span class="o">..</span><span class="nn">cmp</span><span class="p">::</span><span class="nf">min</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="k">self</span><span class="py">.height</span><span class="p">,</span><span class="k">self</span><span class="py">.height</span><span class="o">+</span><span class="k">self</span><span class="py">.y_offset</span><span class="o">+</span> <span class="mi">2</span><span class="o">*</span> <span class="nn">SystemFont</span><span class="p">::</span><span class="nf">glyph_height</span><span class="p">())</span> <span class="p">{</span>
                <span class="k">for</span> <span class="n">x</span> <span class="n">in</span> <span class="mi">0</span><span class="o">..</span><span class="k">self</span><span class="py">.width</span> <span class="p">{</span>
                    <span class="k">self</span><span class="py">.screen</span><span class="p">[(</span><span class="n">y</span><span class="o">*</span><span class="k">self</span><span class="py">.width</span> <span class="o">+</span><span class="n">x</span><span class="p">)</span> <span class="k">as</span> <span class="nb">usize</span><span class="p">]</span> <span class="o">=</span> <span class="k">self</span><span class="py">.bg_color</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="c">// versetze Fenster um eine Zeilenhöhe, </span>
            <span class="k">self</span><span class="py">.y_offset</span> <span class="o">=</span> <span class="k">self</span><span class="py">.y_offset</span> <span class="o">+</span> <span class="nn">SystemFont</span><span class="p">::</span><span class="nf">glyph_height</span><span class="p">();</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="c">// sonst gehe zum Pufferbeginn</span>
            <span class="k">self</span><span class="py">.row</span> <span class="o">=</span> <span class="k">self</span><span class="py">.row</span> <span class="err">-</span> <span class="p">(</span><span class="k">self</span><span class="py">.height</span> <span class="err">/</span> <span class="nn">SystemFont</span><span class="p">::</span><span class="nf">glyph_height</span><span class="p">())</span> <span class="err">-</span> <span class="mi">1</span><span class="p">;</span>
            <span class="k">self</span><span class="py">.y_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="c">// lösche letzte Zeile</span>
            <span class="k">for</span> <span class="n">y</span> <span class="n">in</span> <span class="k">self</span><span class="py">.height</span> <span class="err">-</span> <span class="p">(</span><span class="k">self</span><span class="py">.height</span> <span class="o">%</span> <span class="nn">SystemFont</span><span class="p">::</span><span class="nf">glyph_height</span><span class="p">())</span><span class="o">..</span><span class="k">self</span><span class="py">.height</span> <span class="p">{</span>
                <span class="k">for</span> <span class="n">x</span> <span class="n">in</span> <span class="mi">0</span><span class="o">..</span><span class="k">self</span><span class="py">.width</span> <span class="p">{</span>
                    <span class="k">self</span><span class="py">.screen</span><span class="p">[(</span><span class="n">y</span><span class="o">*</span><span class="k">self</span><span class="py">.width</span> <span class="o">+</span><span class="n">x</span><span class="p">)</span> <span class="k">as</span> <span class="nb">usize</span><span class="p">]</span> <span class="o">=</span> <span class="k">self</span><span class="py">.bg_color</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">let</span> <span class="k">mut</span> <span class="n">prob_tag_buf</span><span class="p">:</span> <span class="n">PropertyTagBuffer</span> <span class="o">=</span> <span class="nn">PropertyTagBuffer</span><span class="p">::</span><span class="nf">new</span><span class="p">();</span>
        <span class="k">let</span> <span class="n">mb</span> <span class="o">=</span> <span class="nf">mailbox</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
        <span class="n">prob_tag_buf</span><span class="nf">.init</span><span class="p">();</span>
        <span class="n">prob_tag_buf</span><span class="nf">.add_tag_with_param</span><span class="p">(</span><span class="nn">Tag</span><span class="p">::</span><span class="n">SetVirtualOffset</span><span class="p">,</span><span class="nf">Some</span><span class="p">(</span><span class="o">&amp;</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="k">self</span><span class="py">.y_offset</span><span class="p">]));</span>
        <span class="n">mb</span><span class="nf">.write</span><span class="p">(</span><span class="nn">Channel</span><span class="p">::</span><span class="n">ATags</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">prob_tag_buf</span><span class="py">.data</span> <span class="k">as</span> <span class="o">*</span><span class="k">const</span> <span class="p">[</span><span class="nb">u32</span><span class="p">;</span> <span class="n">BUFFER_SIZE</span><span class="p">]</span> <span class="k">as</span> <span class="nb">u32</span><span class="p">);</span>
        <span class="n">mb</span><span class="nf">.read</span><span class="p">(</span><span class="nn">Channel</span><span class="p">::</span><span class="n">ATags</span><span class="p">);</span>
    <span class="p">}</span></pre></td></tr></tbody></table></code></pre></figure>

<h3 id="no-race-codition">(No) Race Codition</h3>

<p>Um den Framebuffer zum Debuggen zu nutzen, muss er initialisiert werden. Wo und wann soll das geschehen? Offensichtlich soll er überall zur Verfügung stehen. Da es nicht
sinnvoll ist, eine entsprechende Variable als Funktionsparameter an sämtliche Funktionen weiterzureichen, muss dies Variable global sein, in Rust heißt das statisch
(Schlüsselwort <code class="highlighter-rouge">static</code>). Da aber nicht nur lesend auf den Framebuffer zugegriffen wird, muss sie auch veränderbar (<em>mutable</em>) sein. In Rust gilt aber jeder Zugriff auf
eine veränderbare statische Variable als unsicher! Durch einen nebenläufigen Zugriff kann es bei einer solchen Variable nämlich zu Wettlaufsituationen (<em>race conditions</em>)
kommen, die dann zu Inkonsistenzen führen.</p>

<p>Nebenläufiger Zugriff? Denn haben wir doch gar nicht, solange wir keine Interrupts einschalten. Das ist zwar richtig, aber Rust weiß das doch nicht. Es kommt also darauf
an, Rust davon zu überzeugen. Natürlich könnten wir auch einfach alle unsicheren Zugriffe in einem Modul kapseln, aber da das Problem ein grundsätzliches ist, was
vielleicht noch häufiger auftritt, ist eine generische Lösung vorzuziehen.</p>

<p>Im Gegensatz zu veränderbaren statischen Variablen sind unverändertere (<em>immutable</em>) überhaupt kein Problem. Leider ist eine unverändertere Frambuffer-Struktur
nutzlos. Rust kennt aber das Konzept der internen Veränderbarkeit (<em>Interior mutability</em>). Die Idee ist, eine unveränderbare Referenz auf einen veränderbaren Wert zu
haben. Damit brauchen wir erst mal kein veränderbares <code class="highlighter-rouge">static</code> mehr. Allerdings muss Rust immer noch überzeugt werden, dass der Zugriff auf den veränderbaren Wert bei
Nebenläufigkeit sicher ist.</p>

<p>Um mit Nebenläufigkeit umzugehen, kennt Rust zwei Traits: <code class="highlighter-rouge">Send</code> und
<code class="highlighter-rouge">Sync</code>. Es sind sogenannte Marker-Traits, die selbst keine Methoden
verlangen. <code class="highlighter-rouge">Send</code> sagt aus, dass es bei nebenläufiger Nutzung eines
Wertes keine <em>race condition</em> gibt, während <code class="highlighter-rouge">Sync</code> dies für die
nebenläufige Nutzung seiner Referenz zusichert. Beide Traits sind
selbst wieder unsicher, was heißt, dass der Compiler die Einhaltung
der Garantien nicht überprüfen kann.</p>

<figure class="highlight"><pre><code class="language-rust" data-lang="rust"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre></td><td class="code"><pre><span class="k">use</span> <span class="nn">core</span><span class="p">::</span><span class="nn">cell</span><span class="p">::</span><span class="n">UnsafeCell</span><span class="p">;</span>

<span class="k">pub</span> <span class="k">struct</span> <span class="n">NoConcurrency</span><span class="o">&lt;</span><span class="n">T</span><span class="p">:</span> <span class="n">Sized</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="n">data</span><span class="p">:</span> <span class="n">UnsafeCell</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">unsafe</span> <span class="k">impl</span><span class="o">&lt;</span><span class="n">T</span><span class="p">:</span> <span class="n">Sized</span> <span class="o">+</span> <span class="nb">Send</span><span class="o">&gt;</span> <span class="n">Sync</span> <span class="k">for</span> <span class="n">NoConcurrency</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="p">{}</span>
<span class="k">unsafe</span> <span class="k">impl</span><span class="o">&lt;</span><span class="n">T</span><span class="p">:</span> <span class="n">Sized</span> <span class="o">+</span> <span class="nb">Send</span><span class="o">&gt;</span> <span class="nb">Send</span> <span class="k">for</span> <span class="n">NoConcurrency</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="p">{}</span>

<span class="k">impl</span><span class="o">&lt;</span><span class="nv">'b</span><span class="p">,</span> <span class="n">T</span><span class="o">&gt;</span> <span class="n">NoConcurrency</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">{</span>
    <span class="k">pub</span> <span class="k">const</span> <span class="k">fn</span> <span class="nf">new</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">T</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="n">NoConcurrency</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="p">{</span>
        <span class="n">NoConcurrency</span><span class="p">{</span>
            <span class="n">data</span><span class="p">:</span> <span class="nn">UnsafeCell</span><span class="p">::</span><span class="nf">new</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">pub</span> <span class="k">fn</span> <span class="nf">set</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">T</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">let</span> <span class="n">r</span> <span class="o">=</span> <span class="k">self</span><span class="py">.data</span><span class="nf">.get</span><span class="p">();</span>
        <span class="k">unsafe</span> <span class="p">{</span> <span class="o">*</span><span class="n">r</span> <span class="o">=</span> <span class="n">data</span><span class="p">;}</span>
    <span class="p">}</span>

    <span class="k">pub</span> <span class="k">fn</span> <span class="nf">get</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="n">T</span> <span class="p">{</span>
        <span class="k">let</span> <span class="n">r</span> <span class="o">=</span><span class="k">self</span><span class="py">.data</span><span class="nf">.get</span><span class="p">();</span>
        <span class="k">unsafe</span> <span class="p">{</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="p">(</span><span class="o">*</span><span class="n">r</span><span class="p">)}</span>
    <span class="p">}</span>
<span class="p">}</span></pre></td></tr></tbody></table></code></pre></figure>

<p>Jetzt können wir uns den Framebuffer anlegen:</p>
<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">static</span> <span class="n">_KPRINT_FB</span><span class="p">:</span> <span class="n">NoConcurrency</span><span class="o">&lt;</span><span class="nb">Option</span><span class="o">&lt;</span><span class="n">Framebuffer</span><span class="o">&lt;</span><span class="nv">'static</span><span class="o">&gt;&gt;&gt;</span> <span class="o">=</span> <span class="nn">NoConcurrency</span><span class="p">::</span><span class="nf">new</span><span class="p">(</span><span class="nb">None</span><span class="p">);</span>
</code></pre></div></div>
<p>Er ist in einer <code class="highlighter-rouge">Option</code> verpackt, damit er beim ersten Aufruf
initialisert wird. Dies kann nicht direkt geschehen, da die
Initialisierung <em>keine</em> konstante Funktion ist, also eine, die schon
zur Übersetzungszeit vollständig berechnet werden kann.
Ist also der interne Wert von <code class="highlighter-rouge">_KPRINT_FB</code> <code class="highlighter-rouge">None</code>, muss die
Initialisierung gerufen werden. Die beiden Funktionen, die den
Framebuffer nutzen, erledigen dies:</p>
<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">#</span><span class="p">[</span><span class="nf">doc</span><span class="p">(</span><span class="n">hidden</span><span class="p">)]</span>
<span class="k">pub</span> <span class="k">fn</span> <span class="nf">fkprintc</span><span class="p">(</span><span class="n">arg</span><span class="p">:</span> <span class="n">Arguments</span><span class="p">,</span><span class="n">color</span><span class="p">:</span> <span class="nb">u32</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">let</span> <span class="n">fbo</span> <span class="o">=</span> <span class="n">_KPRINT_FB</span><span class="nf">.get</span><span class="p">();</span>
    <span class="k">match</span> <span class="o">*</span><span class="n">fbo</span> <span class="p">{</span>
        <span class="nf">Some</span><span class="p">(</span><span class="k">ref</span> <span class="k">mut</span> <span class="n">fb</span><span class="p">)</span> <span class="k">=&gt;</span> <span class="p">{</span>
            <span class="k">let</span> <span class="n">c_old</span> <span class="o">=</span> <span class="n">fb</span><span class="nf">.get_color</span><span class="p">();</span>
            <span class="n">fb</span><span class="nf">.set_color</span><span class="p">(</span><span class="n">color</span><span class="p">);</span>
            <span class="nf">write</span><span class="p">(</span><span class="n">fb</span><span class="p">,</span><span class="n">arg</span><span class="p">)</span><span class="nf">.expect</span><span class="p">(</span><span class="s">""</span><span class="p">);</span>
            <span class="n">fb</span><span class="nf">.set_color</span><span class="p">(</span><span class="n">c_old</span><span class="p">);</span>
        <span class="p">},</span>
        <span class="nb">None</span> <span class="k">=&gt;</span> <span class="p">{</span>
            <span class="nf">kprint_init</span><span class="p">();</span>
            <span class="nf">fkprintc</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">color</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="nd">#[doc(hidden)]</span>
<span class="k">pub</span> <span class="k">fn</span> <span class="nf">fkprint</span><span class="p">(</span><span class="n">arg</span><span class="p">:</span> <span class="n">Arguments</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">let</span> <span class="n">fbo</span> <span class="o">=</span> <span class="n">_KPRINT_FB</span><span class="nf">.get</span><span class="p">();</span>
    <span class="k">match</span> <span class="o">*</span><span class="n">fbo</span> <span class="p">{</span>
        <span class="nf">Some</span><span class="p">(</span><span class="k">ref</span> <span class="k">mut</span> <span class="n">fb</span><span class="p">)</span> <span class="k">=&gt;</span> <span class="p">{</span>
            <span class="nf">write</span><span class="p">(</span><span class="n">fb</span><span class="p">,</span><span class="n">arg</span><span class="p">)</span><span class="nf">.expect</span><span class="p">(</span><span class="s">""</span><span class="p">);</span>
        <span class="p">},</span>
        <span class="nb">None</span> <span class="k">=&gt;</span> <span class="p">{</span>
            <span class="nf">kprint_init</span><span class="p">();</span>
            <span class="nf">fkprint</span><span class="p">(</span><span class="n">arg</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="nd">#[doc(hidden)]</span>
<span class="k">pub</span> <span class="k">fn</span> <span class="nf">kprint_init</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">_KPRINT_FB</span><span class="nf">.set</span><span class="p">(</span><span class="nf">Some</span><span class="p">(::</span><span class="nn">framebuffer</span><span class="p">::</span><span class="nn">Framebuffer</span><span class="p">::</span><span class="nf">new</span><span class="p">()));</span>
    <span class="nf">kprint_clear</span><span class="p">()</span>
<span class="p">}</span>
</code></pre></div></div>
<p>Zur Erleichterung habe ich noch ein Macro geschrieben, dass ich zum
Debuggen einsetzen werde. Ich möchte nämlich nicht zwischen meinen
Aufrufen wechseln, je nachdem, ob ich eine die Schrift in einer
anderen Farbe ausgeben will oder nicht. Leider kennt Rust ja keine
Default-Argumente, aber auf Macroebene ist dies kein Problem:</p>
<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">#</span><span class="p">[</span><span class="n">macro_export</span><span class="p">]</span>
<span class="c">/// Consolenausgabe vom Kernel aus (_kernel print_).</span>
<span class="c">/// Dient im Wesentlichen für Debugging-Zwecke während der Kernel-Entwicklung</span>
<span class="nd">macro_rules!</span> <span class="n">kprint</span> <span class="p">{</span>
    <span class="p">(</span><span class="nv">$</span><span class="p">(</span><span class="nv">$a</span><span class="p">:</span> <span class="n">expr</span><span class="p">),</span><span class="o">*</span><span class="p">)</span> <span class="k">=&gt;</span> <span class="p">{</span> <span class="nv">$crate</span><span class="p">::</span><span class="nn">kprint</span><span class="p">::</span><span class="nf">fkprint</span><span class="p">(</span><span class="nd">format_args!</span><span class="p">(</span><span class="nv">$</span><span class="p">(</span><span class="nv">$a</span><span class="p">),</span><span class="o">*</span><span class="p">));</span> <span class="p">};</span>
    <span class="p">(</span><span class="nv">$</span><span class="p">(</span><span class="nv">$a</span><span class="p">:</span> <span class="n">expr</span><span class="p">),</span><span class="o">*</span> <span class="p">;</span> <span class="nv">$c</span><span class="p">:</span> <span class="n">ident</span><span class="p">)</span> <span class="k">=&gt;</span> <span class="p">{</span> <span class="nv">$crate</span><span class="p">::</span><span class="nn">kprint</span><span class="p">::</span><span class="nf">fkprintc</span><span class="p">(</span><span class="nd">format_args!</span><span class="p">(</span><span class="nv">$</span><span class="p">(</span><span class="nv">$a</span><span class="p">),</span><span class="o">*</span><span class="p">),</span><span class="nv">$crate</span><span class="p">::</span><span class="nn">kprint</span><span class="p">::</span><span class="nv">$c</span><span class="p">);</span> <span class="p">};</span>
    <span class="p">(</span><span class="nv">$</span><span class="p">(</span><span class="nv">$a</span><span class="p">:</span> <span class="n">expr</span><span class="p">),</span><span class="o">*</span> <span class="p">;</span> <span class="nv">$c</span><span class="p">:</span> <span class="n">expr</span><span class="p">)</span> <span class="k">=&gt;</span> <span class="p">{</span> <span class="nv">$crate</span><span class="p">::</span><span class="nn">kprint</span><span class="p">::</span><span class="nf">fkprintc</span><span class="p">(</span><span class="nd">format_args!</span><span class="p">(</span><span class="nv">$</span><span class="p">(</span><span class="nv">$a</span><span class="p">),</span><span class="o">*</span><span class="p">),</span><span class="nv">$c</span><span class="p">);</span> <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="der-linker-zickt-mal-wieder">Der Linker zickt mal wieder</h2>

<p>Bei der Übersetzung des Codes entsteht ein Linkerfehler:</p>

<div class="window">
          <nav class="control-window">
            <a href="#finder" class="close" data-rel="close">close</a>
            <a href="#" class="minimize">minimize</a>
            <a href="#" class="deactivate">deactivate</a>
          </nav>
          <h1 class="titleInside">Terminal</h1>
          <div class="container"><div class="terminal"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">&nbsp;</span>
<span class="line-number">&nbsp;</span>
<span class="line-number">&nbsp;</span></pre></td><td class="code"><pre><code><span class="line output">error: linking with `arm-none-eabi-gcc` failed: exit code: 1
</span><span class="line output">    /Users/mwerner/Development/aihPOS/xargo/aih_pos/src/hal/board/framebuffer.rs:198: undefined reference to `__aeabi_uidiv`
</span><span class="line output">    /Users/mwerner/Development/aihPOS/xargo/aih_pos/src/hal/board/framebuffer.rs:201: undefined reference to `__aeabi_uidivmod`</span></code></pre></td></tr></table></div></div>
        </div>

<p>Eine kurze Recherche zeigt, wo er herkommt: Unser Prozessor kann keine Ganzzahldivision (aber Gleitkommadivision!) und der Compiler verlässt sich darauf, dass die
Plattform entsprechenden Code zur Verfügung stellt, was wir aber bisher nicht machen. Da es einige dieser Befehle gibt, verzichte ich darauf, sie alle per Hand zu
definieren und greife auf die <a href="https://github.com/rust-lang-nursery/compiler-builtins">Compiler-Buildins-Bibliothek</a> zurück, die in der „Rust Language Nursery“ zur Verfügung gestellt wird.</p>

<p>Nun habe ich schon zwei Rust-Bibliotheken (core und compiler-buildins), die händisch eingepflegt werden, wenn es zu Updates bei ihnen oder dem Compiler kommt. Höchste
Zeit, das Projekt auf Rust-Tools umzustellen, die dies automatisch erledigen. Dies wird das Thema des nächsten Beitrags sein.</p>

<p><a class="left button tiny radius" href="http://sysop.matthias-werner.net/aihpos/2017/04/10/aihpos-lebenszeichen/"><span class="icon-chevron-left"></span>Vorheriger Beitrag in AIHPOS</a></p>

<p><a class="right button tiny radius r15" href="http://sysop.matthias-werner.net/aihpos/2017/05/14/aihpos-umrustung/">Nächster Beitrag in AIHPOS<span class="icon-chevron-right"></span></a></p>

<div class="row"></div>

<div class="footnotes">
  <ol>
    <li id="fn:1">
      <p>Das ist nicht ganz präzise: Rust hält das „natürliche“ Alignment ein, das ggf. durch <code class="highlighter-rouge">#[repr(packed)]</code> unterlaufen werden kann. <a href="#fnref:1" class="reversefootnote">&#8617;</a></p>
    </li>
    <li id="fn:2">
      <p>Version 6d841da vom 22. April 2017 <a href="#fnref:2" class="reversefootnote">&#8617;</a></p>
    </li>
    <li id="fn:3">
      <p>Eine weitere Alternative für das Debuggen wäre auch noch die Nutzung der UART. <a href="#fnref:3" class="reversefootnote">&#8617;</a></p>
    </li>
    <li id="fn:4">
      <p>Diese Darstellung ist etwas vereinfacht. <a href="#fnref:4" class="reversefootnote">&#8617;</a></p>
    </li>
    <li id="fn:5">
      <p>Genau genommen bräuchte man dafür nur ein oder zwei „Reservezeilen“, aber so sind wir etwas flexibler. <a href="#fnref:5" class="reversefootnote">&#8617;</a></p>
    </li>
    <li id="fn:6">
      <p>Es wäre dann vermutlich besser, wenn ein <code class="highlighter-rouge">u8</code>-Array genutzt würde. <a href="#fnref:6" class="reversefootnote">&#8617;</a></p>
    </li>
  </ol>
</div>

	                </span>
			
						<div id="page-meta" class="t30">
				<p>
					<!-- Look the author details up from the site config. -->
					
					<!-- Output author details if some exist. -->
					
					<span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name" class="pr20 icon-edit"><a href="http://osg.informatik.tu-chemnitz.de/Staff/M_Werner/index.php?lang=en" target="_blank"> Matthias Werner</a></span>
				</span>
				

				
				<time class="icon-calendar pr20" datetime="2017-04-26" itemprop="datePublished"> 2017-04-26</time>
				

				<span class="icon-archive pr20"> AIHPOS</span>
				<br />
				<span class="pr20"><span class="icon-price-tag pr10"> aihPOS</span> <span class="icon-price-tag pr10"> Raspberry Pi</span> <span class="icon-price-tag pr10"> Rust</span> </span>
			</p>

			<div id="post-nav" class="row">
				
				<div class="small-5 columns"><a class="button small radius prev" href="http://sysop.matthias-werner.net/menschen/2017/04/20/march-for-science/">&laquo; March for Science</a></div><!-- /.small-4.columns -->
				
				<div class="small-2 columns text-center"><a class="radius button small" href="http://sysop.matthias-werner.net/blog/archive/" title="Blog Archiv">Archiv</a></div><!-- /.small-4.columns -->
				
				<div class="small-5 columns text-right"><a class="button small radius next" href="http://sysop.matthias-werner.net/aihpos/2017/05/14/aihpos-umrustung/">Um-Rust-ung &raquo;</a></div><!-- /.small-4.columns -->
				
			</div>
			</div><!--  /.page-meta -->
			

	                
		</article>
	</div><!-- /.medium-12.columns -->
</div><!-- /.row -->




	
	    <div id="up-to-top" class="row">
      <div class="small-12 columns" style="text-align: right;">
        <a class="iconfont" href="#top-of-page">&#xf108;</a>
      </div><!-- /.small-12.columns -->
    </div><!-- /.row -->


    <footer id="footer-content" class="bg-grau">
      <div id="footer">
        <div class="row">
          <div class="medium-6 large-5 columns">
            <h5 class="shadow-black">Über diese Website</h5>

            <p class="shadow-black">
              Matthias Werners Blog. 
              <a href="http://sysop.matthias-werner.net/info/">Mehr ›</a>
            </p>
          </div><!-- /.large-6.columns -->


          <div class="small-6 medium-3 large-3 large-offset-1 columns">
            
              
              <ul class="no-bullet shadow-black">
              
              </ul>
          </div><!-- /.large-4.columns -->


          <div class="small-6 medium-3 large-3 columns">
            
              
            <ul class="no-bullet shadow-black">
            
            </ul>
          </div><!-- /.large-3.columns -->
        </div><!-- /.row -->

      </div><!-- /#footer -->

    </footer>

	

	


<script src="http://sysop.matthias-werner.net/assets/js/javascript.min.js"></script>














</body>
</html>

